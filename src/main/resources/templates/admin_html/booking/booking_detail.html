<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Booking - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="min-h-screen bg-gray-50 font-sans">
<div class="flex min-h-screen relative">
    <!-- Sidebar -->
    <aside th:replace="~{admin_html/fragment/sidebar :: sidebar}"></aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto p-8 ml-[18.5rem]">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header Section -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                <div>
                    <div class="flex items-center gap-3">
                         <a onclick="window.history.back()" class="cursor-pointer text-gray-400 hover:text-indigo-600">
                            <i class="fas fa-arrow-left text-2xl"></i>
                        </a>
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800">Chi tiết Booking</h1>
                            <p class="text-gray-500 mt-1" th:text="'Mã booking: #' + ${booking.booking_id}"></p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 sm:mt-0">
                    <span class="px-3 py-1.5 rounded-full text-sm font-semibold capitalize"
                          th:classappend="${(booking.status == 'Pending payment') ? 'bg-amber-100 text-amber-800' :
                                              (booking.status == 'Paid') ? 'bg-green-100 text-green-800' :
                                              (booking.status == 'Cash') ? 'bg-blue-100 text-blue-800' :
                                              (booking.status == 'Cancelled') ? 'bg-red-100 text-red-800' :
                                              'bg-purple-100 text-purple-800'}"
                          th:text="${booking.status.replace('_', ' ')}">
                    </span>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Tour Information -->
                    <div class="bg-white rounded-xl shadow-sm">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                <i class="fas fa-map-marked-alt text-indigo-500 mr-3"></i> Thông tin tour
                            </h2>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div class="col-span-2">
                                <label class="block text-sm text-gray-500">Tên tour</label>
                                <p class="font-semibold text-lg text-gray-800" th:text="${booking.tour_name}"></p>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500">Ngày đặt</label>
                                <p class="font-medium text-gray-800" th:text="${#temporals.format(booking.booking_date, 'dd/MM/yyyy HH:mm')}"></p>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500">Ngày khởi hành</label>
                                <p class="font-medium text-gray-800" th:text="${#temporals.format(booking.start_date, 'dd/MM/yyyy')}"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="bg-white rounded-xl shadow-sm">
                         <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                <i class="fas fa-user text-indigo-500 mr-3"></i> Thông tin khách hàng
                            </h2>
                        </div>
                        <div class="p-6 flex items-start">
                            <div class="w-12 h-12 rounded-full bg-indigo-100 flex-shrink-0 flex items-center justify-center text-indigo-600 font-bold text-xl mr-4"
                                 th:text="${#strings.substring(booking.user_full_name, 0, 1).toUpperCase()}"></div>
                            <div class="flex-grow">
                                <h3 class="font-bold text-lg text-gray-800" th:text="${booking.user_full_name}"></h3>
                                <p class="text-sm text-gray-500" th:text="'User ID: ' + ${booking.user_id}"></p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mt-4">
                                    <div>
                                        <label class="block text-sm text-gray-500">Email</label>
                                        <p class="font-medium text-gray-800" th:text="${booking.user_email}"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-500">Số điện thoại</label>
                                        <p class="font-medium text-gray-800" th:text="${booking.user_phone_number}"></p>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm text-gray-500">Địa chỉ</label>
                                        <p class="font-medium text-gray-800" th:text="${booking.user_address}"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- Notes & Cancellation -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-sticky-note text-indigo-500 mr-3"></i> Ghi chú & Lý do hủy
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-500">Ghi chú của khách hàng</label>
                                <p class="font-medium text-gray-800 italic" th:text="${booking.note != null and !booking.note.isEmpty() ? booking.note : 'Không có ghi chú.'}"></p>
                            </div>
                            <div th:if="${booking.status == 'Cancelled'}" class="pt-4 border-t border-gray-200">
                                <label class="block text-sm text-red-500 font-semibold">Lý do hủy</label>
                                <p class="font-medium text-gray-800" th:text="${booking.cancel_reason}"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-8">
                    <!-- Payment Summary -->
                    <div class="bg-white rounded-xl shadow-sm">
                         <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                <i class="fas fa-wallet text-indigo-500 mr-3"></i> Chi tiết thanh toán
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3 text-gray-700">
                                <div class="flex justify-between">
                                    <span>Người lớn</span>
                                    <span class="font-medium" th:text="${booking.number_of_adults} + ' × ' + ${#numbers.formatInteger(booking.tour.tour_adult_price, 3, 'POINT')} + '₫'"></span>
                                </div>
                                <div class="flex justify-between" th:if="${booking.number_of_children > 0}">
                                    <span>Trẻ em</span>
                                    <span class="font-medium" th:text="${booking.number_of_children} + ' × ' + ${#numbers.formatInteger(booking.tour.tour_child_price, 3, 'POINT')} + '₫'"></span>
                                </div>
                                <div class="flex justify-between" th:if="${booking.number_of_infants > 0}">
                                    <span>Em bé</span>
                                    <span class="font-medium" th:text="${booking.number_of_infants} + ' × ' + ${#numbers.formatInteger(booking.tour.tour_infant_price, 3, 'POINT')} + '₫'"></span>
                                </div>
                                <div class="flex justify-between" th:if="${booking.voucher_discount != null && booking.voucher_discount > 0}">
                                    <span>Giảm giá voucher</span>
                                    <span class="font-medium text-red-500" th:text="'-' + ${#numbers.formatInteger(booking.voucher_discount, 3, 'POINT')} + '₫'"></span>
                                </div>
                                <div class="border-t border-gray-200 pt-4 mt-4">
                                    <div class="flex justify-between font-bold text-xl text-gray-900">
                                        <span>Tổng cộng</span>
                                        <span class="text-indigo-600" th:text="${#numbers.formatInteger(booking.total_price, 3, 'POINT')} + '₫'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-cog text-indigo-500 mr-3"></i> Thao tác
                        </h2>
                        <div class="space-y-3">
                            <button th:if="${booking.status == 'Cash'}"
                                    th:data-booking-id="${booking.booking_id}"
                                    onclick="confirmPayment(event, this.getAttribute('data-booking-id'))"
                                    class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center transition-colors">
                                <i class="fas fa-money-bill-wave mr-2"></i> Xác nhận đã thanh toán
                            </button>
                             <button th:if="${(booking.status == 'Paid' or booking.status == 'Cash') and #temporals.createNow().toLocalDate().isAfter(booking.end_date)}"
                                    th:data-booking-id="${booking.booking_id}"
                                    onclick="confirmCompleted(event, this.getAttribute('data-booking-id'))"
                                    class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold flex items-center justify-center transition-colors">
                                <i class="fas fa-check-double mr-2"></i> Đánh dấu hoàn thành
                            </button>
                            <button th:if="${booking.status != 'Cancelled' and booking.status != 'Completed'}"
                                    th:data-booking-id="${booking.booking_id}"
                                    onclick="cancelBooking(event, this.getAttribute('data-booking-id'))"
                                    class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold flex items-center justify-center transition-colors">
                                <i class="fas fa-times mr-2"></i> Hủy booking
                            </button>
                             <div th:if="${booking.status == 'Cancelled' or booking.status == 'Completed'}" class="text-center text-gray-500 text-sm">
                                <p>Đơn hàng đã ở trạng thái cuối cùng, không thể thao tác.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modals -->
<!--Confirm Cash Payment Modal -->
<div id="confirmPaymentModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-money-bill-wave text-green-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Xác nhận thanh toán tiền mặt</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Bạn có chắc chắn muốn xác nhận booking này đã được thanh toán bằng tiền mặt?</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmPaymentBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 sm:ml-3 sm:w-auto sm:text-sm">
                    <span id="paymentSpinner" class="hidden mr-2">
                        <i class="fas fa-spinner animate-spin"></i>
                    </span>
                    Xác nhận
                </button>
                <button type="button" id="cancelPaymentBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                    Hủy bỏ
                </button>
            </div>
        </div>
    </div>
</div>
<!--Confirm Complete Payment Modal -->
<div id="confirmCompletedModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-check text-blue-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Đánh dấu Hoàn thành</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Bạn có chắc chắn muốn đánh dấu booking này đã hoàn thành?</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmCompletedBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                    <span id="completedSpinner" class="hidden mr-2">
                         <i class="fas fa-spinner animate-spin"></i>
                    </span>
                    Xác nhận
                </button>
                <button type="button" id="cancelCompletedBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                    Hủy bỏ
                </button>
            </div>
        </div>
    </div>
</div>
<!--Cancel Booking Modal -->
<div id="cancelBookingModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Xác nhận hủy booking</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Bạn có chắc chắn muốn hủy booking này?</p>
                            <div class="mt-4">
                                <label for="cancelReason" class="block text-sm font-medium text-gray-700">Lý do hủy</label>
                                <textarea id="cancelReason" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmCancelBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                    <span id="cancelSpinner" class="hidden mr-2">
                        <i class="fas fa-spinner animate-spin"></i>
                    </span>
                    Xác nhận hủy
                </button>
                <button type="button" id="cancelCancelBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                    Quay lại
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentBookingId = null;

        // --- Confirm Payment Logic ---
        const confirmPaymentModal = document.getElementById('confirmPaymentModal');
        const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
        const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
        const paymentSpinner = document.getElementById('paymentSpinner');

        window.confirmPayment = function(event, bookingId) {
            event.preventDefault();
            currentBookingId = bookingId;
            if(confirmPaymentModal) confirmPaymentModal.classList.remove('hidden');
        }
        if(confirmPaymentBtn) confirmPaymentBtn.addEventListener('click', () => handleAction('/Client/orderBooking/confirm_cash_payment/', paymentSpinner, confirmPaymentBtn, confirmPaymentModal));
        if(cancelPaymentBtn) cancelPaymentBtn.addEventListener('click', () => confirmPaymentModal.classList.add('hidden'));

        // --- Confirm Completed Logic ---
        const confirmCompletedModal = document.getElementById('confirmCompletedModal');
        const confirmCompletedBtn = document.getElementById('confirmCompletedBtn');
        const cancelCompletedBtn = document.getElementById('cancelCompletedBtn');
        const completedSpinner = document.getElementById('completedSpinner');

        window.confirmCompleted = function(event, bookingId) {
            event.preventDefault();
            currentBookingId = bookingId;
            if(confirmCompletedModal) confirmCompletedModal.classList.remove('hidden');
        }
        if(confirmCompletedBtn) confirmCompletedBtn.addEventListener('click', () => handleAction('/admin/tourBookings/confirm_completed/', completedSpinner, confirmCompletedBtn, confirmCompletedModal));
        if(cancelCompletedBtn) cancelCompletedBtn.addEventListener('click', () => confirmCompletedModal.classList.add('hidden'));
        
        // --- Cancel Booking Logic ---
        const cancelBookingModal = document.getElementById('cancelBookingModal');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const cancelCancelBtn = document.getElementById('cancelCancelBtn');
        const cancelSpinner = document.getElementById('cancelSpinner');
        
        window.cancelBooking = function(event, bookingId) {
            event.preventDefault();
            currentBookingId = bookingId;
            if(cancelBookingModal) cancelBookingModal.classList.remove('hidden');
        }
        if(confirmCancelBtn) confirmCancelBtn.addEventListener('click', function() {
            const cancelReason = document.getElementById('cancelReason').value;
            if (!cancelReason) {
                alert('Vui lòng nhập lý do hủy');
                return;
            }
            handleAction('/Client/orderBooking/cancelBooking/', cancelSpinner, confirmCancelBtn, cancelBookingModal, cancelReason);
        });
        if(cancelCancelBtn) cancelCancelBtn.addEventListener('click', () => cancelBookingModal.classList.add('hidden'));

        // --- Generic Action Handler ---
        function handleAction(url, spinner, button, modal, body = null) {
            button.disabled = true;
            spinner.classList.remove('hidden');

            fetch(url + currentBookingId, {
                method: 'POST',
                headers: body ? { 'Content-Type': 'application/json' } : {},
                body: body ? JSON.stringify(body) : null
            })
            .then(response => {
                if (!response.ok) { return response.json().then(err => { throw err; }); }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Thao tác thành công!');
                    window.location.reload();
                } else {
                    throw new Error(data.message || 'Lỗi không xác định');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra: ' + (error.message || 'Vui lòng thử lại.'));
            })
            .finally(() => {
                button.disabled = false;
                spinner.classList.add('hidden');
                modal.classList.add('hidden');
            });
        }
    });
</script>
</body>
</html>