<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Booking - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }

        .status-badge i {
            margin-right: 0.25rem;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-paid {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-cash {
            background-color: #e0f2fe;
            color: #0369a1;
        }

        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-completed {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .detail-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .avatar {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #6366f1, #10b981);
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
<div class="flex">
    <!-- Sidebar -->
    <aside th:replace="~{admin_html/fragment/sidebar :: sidebar}"></aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header Section -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Chi tiết Booking</h1>
                    <div class="flex items-center mt-2">
                        <span class="text-gray-600">Mã booking:</span>
                        <span class="font-medium ml-2" th:text="${booking.booking_id}"></span>
                        <span th:switch="${booking.status}" class="ml-4 status-badge">
                            <span th:case="'Pending payment'" class="status-pending">
                                <i class="fas fa-clock"></i> Chờ thanh toán
                            </span>
                            <span th:case="'Paid'" class="status-paid">
                                <i class="fas fa-check-circle"></i> Đã thanh toán
                            </span>
                            <span th:case="'Cash'" class="status-cash">
                                <i class="fas fa-money-bill-wave"></i> Tiền mặt
                            </span>
                            <span th:case="'Cancelled'" class="status-cancelled">
                                <i class="fas fa-times-circle"></i> Đã hủy
                            </span>
                            <span th:case="'Completed'" class="status-completed">
                                <i class="fas fa-check-double"></i> Hoàn thành
                            </span>
                        </span>
                    </div>
                </div>
                <div class="mt-4 cursor-pointer md:mt-0">
                    <div onclick="window.history.back()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i> Quay lại
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Tour Information -->
                    <div class="detail-card p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-map-marked-alt text-indigo-500 mr-2"></i> Thông tin tour
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-500">Tên tour</label>
                                <p class="font-medium" th:text="${booking.tour_name}"></p>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500">Ngày đặt</label>
                                <p class="font-medium" th:text="${#temporals.format(booking.booking_date, 'dd/MM/yyyy HH:mm')}"></p>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500">Ngày khởi hành</label>
                                <p class="font-medium" th:text="${#temporals.format(booking.start_date, 'dd/MM/yyyy')}"></p>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500">Ngày kết thúc</label>
                                <p class="font-medium" th:text="${#temporals.format(booking.end_date, 'dd/MM/yyyy')}"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="detail-card p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-user text-indigo-500 mr-2"></i> Thông tin khách hàng
                        </h2>
                        <div class="flex items-start mb-4">
                            <div class="avatar rounded-full mr-4"
                                 th:text="${#strings.substring(booking.user_full_name, 0, 1).toUpperCase()}"></div>
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-800" th:text="${booking.user_full_name}"></h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                    <div>
                                        <label class="block text-sm text-gray-500">Email</label>
                                        <p class="font-medium" th:text="${booking.user_email}"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-500">Số điện thoại</label>
                                        <p class="font-medium" th:text="${booking.user_phone_number}"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-500">Địa chỉ</label>
                                        <p class="font-medium" th:text="${booking.user_address}"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-500">User ID</label>
                                        <p class="font-medium" th:text="${booking.user_id}"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Booking Details -->
                    <div class="detail-card p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-receipt text-indigo-500 mr-2"></i> Chi tiết booking
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-500">Số người lớn</label>
                                <p class="font-medium" th:text="${booking.number_of_adults}"></p>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500">Số trẻ em</label>
                                <p class="font-medium" th:text="${booking.number_of_children}"></p>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500">Số em bé</label>
                                <p class="font-medium" th:text="${booking.number_of_infants}"></p>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500">Giảm giá voucher</label>
                                <p class="font-medium" th:text="${booking.voucher_discount != null ? booking.voucher_discount + '₫' : 'Không áp dụng'}"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Notes & Cancellation -->
                    <div class="detail-card p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-sticky-note text-indigo-500 mr-2"></i> Ghi chú & Hủy booking
                        </h2>
                        <div class="mb-4">
                            <label class="block text-sm text-gray-500">Ghi chú</label>
                            <p class="font-medium" th:text="${booking.note != null ? booking.note : 'Không có ghi chú'}"></p>
                        </div>
                        <div th:if="${booking.status == 'Cancelled'}">
                            <label class="block text-sm text-gray-500">Lý do hủy</label>
                            <p class="font-medium" th:text="${booking.cancel_reason}"></p>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Payment Summary -->
                    <div class="detail-card p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-wallet text-indigo-500 mr-2"></i> Thanh toán
                        </h2>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Người lớn</span>
                                <span th:text="${booking.number_of_adults} + ' × ' + ${#numbers.formatInteger(booking.tour.tour_adult_price, 3, 'POINT')} + '₫'"></span>
                            </div>
                            <div class="flex justify-between" th:if="${booking.number_of_children > 0}">
                                <span class="text-gray-600">Trẻ em</span>
                                <span th:text="${booking.number_of_children} + ' × ' + ${#numbers.formatInteger(booking.tour.tour_child_price, 3, 'POINT')} + '₫'"></span>
                            </div>
                            <div class="flex justify-between" th:if="${booking.number_of_infants > 0}">
                                <span class="text-gray-600">Em bé</span>
                                <span th:text="${booking.number_of_infants} + ' × ' + ${#numbers.formatInteger(booking.tour.tour_infant_price, 3, 'POINT')} + '₫'"></span>
                            </div>
                            <div class="flex justify-between" th:if="${booking.voucher_discount != null && booking.voucher_discount > 0}">
                                <span class="text-gray-600">Giảm giá voucher</span>
                                <span class="text-red-500" th:text="'-' + ${#numbers.formatInteger(booking.voucher_discount, 3, 'POINT')} + '₫'"></span>
                            </div>
                            <div class="border-t border-gray-200 pt-3 mt-3">
                                <div class="flex justify-between font-bold text-lg">
                                    <span>Tổng cộng</span>
                                    <span th:text="${#numbers.formatInteger(booking.total_price, 3, 'POINT')} + '₫'"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="detail-card p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-cog text-indigo-500 mr-2"></i> Thao tác
                        </h2>
                        <div class="space-y-3">
                            <button th:if="${booking.status == 'Cash'}"
                                    th:data-booking-id="${booking.booking_id}"
                                    onclick="confirmPayment(event, this.getAttribute('data-booking-id'))"
                                    class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center">
                                <i class="fas fa-money-bill-wave mr-2"></i> Xác nhận đã thanh toán tiền mặt
                            </button>
                            <button th:if="${booking.status == 'Paid' and #temporals.createNow().toLocalDate().isAfter(booking.end_date)}"
                                    th:data-booking-id="${booking.booking_id}"
                                    onclick="confirmCompleted(event, this.getAttribute('data-booking-id'))"
                                    class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center">
                                <i class="fas fa-check-double mr-2"></i> Đánh dấu đã hoàn thành
                            </button>
                            <button th:if="${booking.status != 'Cancelled' && booking.status != 'Completed'}"
                                    th:data-booking-id="${booking.booking_id}"
                                    onclick="cancelBooking(event, this.getAttribute('data-booking-id'))"
                                    class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center justify-center">
                                <i class="fas fa-times mr-2"></i> Hủy booking
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<!--Confirm Cash Payment Modal -->
<div id="confirmPaymentModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-money-bill-wave text-green-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Xác nhận thanh toán tiền mặt</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Bạn có chắc chắn muốn xác nhận booking này đã được thanh toán bằng tiền mặt?</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmPaymentBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                    <span id="paymentSpinner" class="hidden mr-2">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                    Xác nhận
                </button>
                <button type="button" id="cancelPaymentBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Hủy bỏ
                </button>
            </div>
        </div>
    </div>
</div>
<!--Confirm Complete Payment Modal -->
<div id="confirmCompletedModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-check text-green-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Xác nhận thanh toán chuyến đi đã hoàn thành</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Bạn có chắc chắn muốn xác nhận booking này đã được hoàn thành?</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmCompletedBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                    <span id="completedSpinner" class="hidden mr-2">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                    Xác nhận
                </button>
                <button type="button" id="cancelCompletedBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Hủy bỏ
                </button>
            </div>
        </div>
    </div>
</div>
<!--Cancel Booking Modal -->
<div id="cancelBookingModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Xác nhận hủy booking</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Bạn có chắc chắn muốn hủy booking này?</p>
                            <div class="mt-4">
                                <label for="cancelReason" class="block text-sm font-medium text-gray-700">Lý do hủy</label>
                                <textarea id="cancelReason" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmCancelBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    <span id="cancelSpinner" class="hidden mr-2">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                    Xác nhận hủy
                </button>
                <button type="button" id="cancelCancelBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Quay lại
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Biến toàn cục
        let currentBookingId = null;
        const cancelCancelBtn = document.getElementById('cancelCancelBtn');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const cancelModal = document.getElementById('cancelBookingModal');
        const cancelSpinner = document.getElementById('cancelSpinner');

        // Hủy booking
        window.cancelBooking = function(event, bookingId) {
            event.preventDefault();
            currentBookingId = bookingId;
            cancelModal.classList.remove('hidden');
        }

        // Xử lý sự kiện xác nhận hủy
        if (confirmCancelBtn) {
            confirmCancelBtn.addEventListener('click', function() {
                const cancelReason = document.getElementById('cancelReason').value;

                if (!cancelReason) {
                    alert('Vui lòng nhập lý do hủy');
                    return;
                }

                // Hiển thị loading
                confirmCancelBtn.disabled = true;
                cancelSpinner.classList.remove('hidden');

                // Gửi yêu cầu hủy booking
                fetch('/Client/orderBooking/cancelBooking/' + currentBookingId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: cancelReason
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            alert('Đã hủy booking thành công');
                            window.location.reload();
                        } else {
                            throw new Error(data.message || 'Lỗi không xác định');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra: ' + error.message);
                    })
                    .finally(() => {
                        confirmCancelBtn.disabled = false;
                        cancelSpinner.classList.add('hidden');
                        cancelModal.classList.add('hidden');
                    });
            });
        }

        // Hủy bỏ thao tác hủy booking
        if (cancelCancelBtn) {
            cancelCancelBtn.addEventListener('click', function() {
                currentBookingId = null;
                document.getElementById('cancelReason').value = '';
                cancelModal.classList.add('hidden');
            });
        }

        // Biến toàn cục thêm vào
        const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
        const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
        const confirmPaymentModal = document.getElementById('confirmPaymentModal');
        const paymentSpinner = document.getElementById('paymentSpinner');

// Hàm mở modal xác nhận thanh toán tiền mặt
        window.confirmPayment = function(event, bookingId) {
            event.preventDefault();
            currentBookingId = bookingId;
            confirmPaymentModal.classList.remove('hidden');
        }

// Xử lý sự kiện xác nhận thanh toán tiền mặt
        if (confirmPaymentBtn) {
            confirmPaymentBtn.addEventListener('click', function() {
                // Hiển thị loading
                confirmPaymentBtn.disabled = true;
                paymentSpinner.classList.remove('hidden');

                // Gửi yêu cầu xác nhận thanh toán
                fetch('/Client/orderBooking/confirm_cash_payment/' + currentBookingId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            throw new Error(data.message || 'Lỗi không xác định');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra: ' + error.message);
                    })
                    .finally(() => {
                        confirmPaymentBtn.disabled = false;
                        paymentSpinner.classList.add('hidden');
                        confirmPaymentModal.classList.add('hidden');
                    });
            });
        }

// Hủy bỏ thao tác xác nhận thanh toán
        if (cancelPaymentBtn) {
            cancelPaymentBtn.addEventListener('click', function() {
                currentBookingId = null;
                confirmPaymentModal.classList.add('hidden');
            });
        }

        // Biến toàn cục thêm vào
        const confirmCompleteBtn = document.getElementById('confirmCompletedBtn');
        const cancelCompleteBtn = document.getElementById('cancelCompletedBtn');
        const confirmCompleteModal = document.getElementById('confirmCompletedModal');
        const completeSpinner = document.getElementById('completedSpinner');

// Hàm mở modal xác nhận thanh toán tiền mặt
        window.confirmCompleted = function(event, bookingId) {
            event.preventDefault();
            currentBookingId = bookingId;
            confirmCompleteModal.classList.remove('hidden');
        }

// Xử lý sự kiện xác nhận thanh toán tiền mặt
        if (confirmCompleteBtn) {
            confirmCompleteBtn.addEventListener('click', function() {
                // Hiển thị loading
                confirmCompleteBtn.disabled = true;
                completeSpinner.classList.remove('hidden');

                // Gửi yêu cầu xác nhận thanh toán
                fetch('/admin/tourBookings/confirm_completed/' + currentBookingId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            throw new Error(data.message || 'Lỗi không xác định');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra: ' + error.message);
                    })
                    .finally(() => {
                        confirmCompleteBtn.disabled = false;
                        completeSpinner.classList.add('hidden');
                        confirmCompleteModal.classList.add('hidden');
                    });
            });
        }

// Hủy bỏ thao tác xác nhận thanh toán
        if (cancelCompleteBtn) {
            cancelCompleteBtn.addEventListener('click', function() {
                currentBookingId = null;
                confirmCompleteModal.classList.add('hidden');
            });
        }
    });
</script>
</body>
</html>