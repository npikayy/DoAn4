<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Booking - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Minimal custom style for active view toggle and filter tabs */
        .active-view {
            background-color: #4f46e5; /* indigo-600 */
            color: #fff;
        }
        .filter-tab.active {
            background: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 14px -1px rgba(79, 70, 229, 0.3);
        }
        /* Animation for view switching */
        .view-container {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
<div class="flex min-h-screen relative">
    <!-- Sidebar -->
    <aside th:replace="~{admin_html/fragment/sidebar :: sidebar}"></aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto p-8 ml-[18.5rem]">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header Section -->
            <div class="mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Quản Lý Đơn Đặt Tour</h1>
                <p class="text-gray-600 mt-1">
                    Tổng cộng <span class="font-semibold text-gray-900" th:text="${bookingPage.totalElements}"></span> đơn được tìm thấy
                </p>
            </div>

            <!-- Filter and View Toggle Section -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <form th:action="@{/admin/tourBookings}" method="get" class="flex flex-col md:flex-row items-center gap-3 flex-grow w-full">
                        <input type="hidden" name="status" th:value="${status}">
                        <div class="relative flex-grow w-full">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" name="searchQuery" th:value="${searchQuery}" placeholder="Tìm kiếm theo tên, mã booking..."
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 w-full">
                        </div>
                        <div class="relative w-full md:w-auto">
                            <select name="userId" class="appearance-none pl-3 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 w-full bg-white">
                                <option value="">Tất cả người dùng</option>
                                <option th:each="user : ${distinctUsers}"
                                        th:value="${user.user_id}"
                                        th:text="${user.full_name}"
                                        th:selected="${user.user_id == userId}"></option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                            </div>
                        </div>
                        <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium w-full md:w-auto flex items-center justify-center">
                            <i class="fas fa-filter mr-2"></i>Lọc
                        </button>
                    </form>
                    <div class="flex-shrink-0 flex items-center bg-gray-100 p-1 rounded-lg">
                        <button id="cardViewBtn" class="px-3 py-1 text-sm font-medium rounded-md text-gray-700">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button id="tableViewBtn" class="px-3 py-1 text-sm font-medium rounded-md text-gray-700">
                            <i class="fas fa-table"></i>
                        </button>
                    </div>
                </div>

                <!-- Status Tabs -->
                <div class="mt-4 border-t border-gray-200 pt-4">
                    <div class="flex space-x-1 sm:space-x-2 overflow-x-auto pb-2">
                         <a th:href="@{/admin/tourBookings(status='all', userId=${userId}, searchQuery=${searchQuery})}"
                           th:classappend="${status == 'all' ? 'active' : 'bg-white hover:bg-gray-100'}"
                           class="filter-tab flex-shrink-0 px-3 sm:px-4 py-2 rounded-lg font-medium text-sm text-gray-700">Tất cả</a>
                        <a th:href="@{/admin/tourBookings(status='Pending payment', userId=${userId}, searchQuery=${searchQuery})}"
                           th:classappend="${status == 'Pending payment' ? 'active' : 'bg-white hover:bg-gray-100'}"
                           class="filter-tab flex-shrink-0 px-3 sm:px-4 py-2 rounded-lg font-medium text-sm text-gray-700">Chờ TT</a>
                        <a th:href="@{/admin/tourBookings(status='Paid', userId=${userId}, searchQuery=${searchQuery})}"
                           th:classappend="${status == 'Paid' ? 'active' : 'bg-white hover:bg-gray-100'}"
                           class="filter-tab flex-shrink-0 px-3 sm:px-4 py-2 rounded-lg font-medium text-sm text-gray-700">Đã TT</a>
                         <a th:href="@{/admin/tourBookings(status='Cash', userId=${userId}, searchQuery=${searchQuery})}"
                           th:classappend="${status == 'Cash' ? 'active' : 'bg-white hover:bg-gray-100'}"
                           class="filter-tab flex-shrink-0 px-3 sm:px-4 py-2 rounded-lg font-medium text-sm text-gray-700">Tiền mặt</a>
                        <a th:href="@{/admin/tourBookings(status='Completed', userId=${userId}, searchQuery=${searchQuery})}"
                           th:classappend="${status == 'Completed' ? 'active' : 'bg-white hover:bg-gray-100'}"
                           class="filter-tab flex-shrink-0 px-3 sm:px-4 py-2 rounded-lg font-medium text-sm text-gray-700">Hoàn thành</a>
                        <a th:href="@{/admin/tourBookings(status='Cancelled', userId=${userId}, searchQuery=${searchQuery})}"
                           th:classappend="${status == 'Cancelled' ? 'active' : 'bg-white hover:bg-gray-100'}"
                           class="filter-tab flex-shrink-0 px-3 sm:px-4 py-2 rounded-lg font-medium text-sm text-gray-700">Đã hủy</a>
                    </div>
                </div>
            </div>

            <!-- Empty State (used by both views) -->
            <div id="emptyState" th:if="${bookingPage.empty}" class="col-span-full rounded-xl p-8 text-center bg-white shadow-sm">
                 <i class="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-medium text-gray-900 mb-2">Không có đơn đặt tour nào</h3>
                <p class="text-gray-500 max-w-md mx-auto">Không tìm thấy đơn đặt tour nào phù hợp với tiêu chí lọc của bạn.</p>
            </div>

            <!-- Booking Cards View -->
            <div id="cardView" class="view-container grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" th:unless="${bookingPage.empty}">
                <div th:each="booking : ${bookingPage.content}"
                     class="bg-white rounded-xl shadow-md overflow-hidden transition-transform transform hover:-translate-y-1 hover:shadow-lg border-t-4"
                     th:classappend="${booking.status == 'Pending payment'} ? 'border-amber-400' :
                                      (${booking.status == 'Paid'} ? 'border-green-500' :
                                      (${booking.status == 'Cash'} ? 'border-blue-500' :
                                      (${booking.status == 'Cancelled'} ? 'border-red-500' : 'border-purple-500')))">
                    <div class="p-6">
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <p class="text-xs text-gray-500 uppercase font-semibold" th:text="'#' + ${booking.booking_id}"></p>
                                <h3 class="text-lg font-bold text-gray-800 truncate" th:text="${booking.tour.tour_name}"></h3>
                                <p class="text-sm text-gray-500 mt-1" th:text="${#temporals.format(booking.booking_date, 'dd/MM/yyyy HH:mm')}"></p>
                            </div>
                            <div class="flex-shrink-0 ml-4 text-right">
                                <div class="text-xl font-bold text-indigo-600"
                                     th:text="${#numbers.formatInteger(booking.total_price, 3, 'POINT') + '₫'}"></div>
                            </div>
                        </div>
                         <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex items-center">
                               <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-sm mr-3"
                                    th:text="${#strings.substring(booking.user_full_name, 0, 1).toUpperCase()}"></div>
                               <div>
                                   <h4 class="font-semibold text-gray-800" th:text="${booking.user_full_name}"></h4>
                                   <p class="text-sm text-gray-500" th:text="${booking.user_phone_number}"></p>
                               </div>
                           </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-6 py-3 flex justify-between items-center">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold capitalize"
                              th:classappend="${(booking.status == 'Pending payment') ? 'bg-amber-100 text-amber-800' :
                                                  (booking.status == 'Paid') ? 'bg-green-100 text-green-800' :
                                                  (booking.status == 'Cash') ? 'bg-blue-100 text-blue-800' :
                                                  (booking.status == 'Cancelled') ? 'bg-red-100 text-red-800' :
                                                  'bg-purple-100 text-purple-800'}"
                              th:text="${booking.status.replace('_', ' ')}">
                        </span>
                        <a th:href="@{'/admin/tourBookings/detail/' + ${booking.booking_id}}"
                           class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                           Xem chi tiết <i class="fas fa-arrow-right ml-2 text-xs"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Booking Table View -->
            <div id="tableView" class="view-container hidden" th:unless="${bookingPage.empty}">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã Booking</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách hàng</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tour</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng tiền</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày đặt</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                                <th scope="col" class="relative px-6 py-3">
                                    <span class="sr-only">Chi tiết</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr th:each="booking : ${bookingPage.content}" class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600" th:text="'#' + ${booking.booking_id}"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-sm"
                                             th:text="${#strings.substring(booking.user_full_name, 0, 1).toUpperCase()}"></div>
                                        <div class="ml-3">
                                            <div class="text-sm font-medium text-gray-900" th:text="${booking.user_full_name}"></div>
                                            <div class="text-sm text-gray-500" th:text="${booking.user_phone_number}"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800" th:text="${booking.tour.tour_name}"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900" th:text="${#numbers.formatInteger(booking.total_price, 3, 'POINT') + '₫'}"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${#temporals.format(booking.booking_date, 'dd/MM/yyyy')}"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full capitalize"
                                          th:classappend="${(booking.status == 'Pending payment') ? 'bg-amber-100 text-amber-800' :
                                                              (booking.status == 'Paid') ? 'bg-green-100 text-green-800' :
                                                              (booking.status == 'Cash') ? 'bg-blue-100 text-blue-800' :
                                                              (booking.status == 'Cancelled') ? 'bg-red-100 text-red-800' :
                                                              'bg-purple-100 text-purple-800'}"
                                          th:text="${booking.status.replace('_', ' ')}">
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <a th:href="@{'/admin/tourBookings/detail/' + ${booking.booking_id}}" class="text-indigo-600 hover:text-indigo-900">Chi tiết</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div th:if="${bookingPage.totalPages > 1}" class="flex justify-center mt-8">
                 <nav class="inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <a th:href="@{/admin/tourBookings(page=${currentPage - 1}, status=${status}, userId=${userId}, searchQuery=${searchQuery})}"
                       th:classappend="${bookingPage.first ? 'pointer-events-none text-gray-300' : 'text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <a th:each="i : ${#numbers.sequence(0, bookingPage.totalPages - 1)}"
                       th:href="@{/admin/tourBookings(page=${i}, status=${status}, userId=${userId}, searchQuery=${searchQuery})}"
                       th:classappend="${i == currentPage ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-4 py-2 border text-sm font-medium"
                       th:text="${i + 1}">
                    </a>
                     <a th:href="@{/admin/tourBookings(page=${currentPage + 1}, status=${status}, userId=${userId}, searchQuery=${searchQuery})}"
                       th:classappend="${bookingPage.last ? 'pointer-events-none text-gray-300' : 'text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </nav>
            </div>
        </div>
    </main>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cardViewBtn = document.getElementById('cardViewBtn');
        const tableViewBtn = document.getElementById('tableViewBtn');
        const cardView = document.getElementById('cardView');
        const tableView = document.getElementById('tableView');
        const emptyState = document.getElementById('emptyState');

        function setView(view) {
             // Only run if there is content to show
            if(emptyState) return;
            
            if (view === 'card') {
                cardView.classList.remove('hidden');
                tableView.classList.add('hidden');
                cardViewBtn.classList.add('active-view');
                tableViewBtn.classList.remove('active-view');
            } else {
                cardView.classList.add('hidden');
                tableView.classList.remove('hidden');
                tableViewBtn.classList.add('active-view');
                cardViewBtn.classList.remove('active-view');
            }
            localStorage.setItem('bookingView', view);
        }

        cardViewBtn.addEventListener('click', () => setView('card'));
        tableViewBtn.addEventListener('click', () => setView('table'));

        const savedView = localStorage.getItem('bookingView') || 'card';
        setView(savedView);
    });
</script>
</body>
</html>