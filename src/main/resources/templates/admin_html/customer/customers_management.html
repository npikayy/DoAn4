<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Khách Hàng - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#4F46E5',
                            DEFAULT: '#4338CA',
                            dark: '#3730A3'
                        },
                        secondary: {
                            light: '#10B981',
                            DEFAULT: '#059669',
                            dark: '#047857'
                        },
                        accent: {
                            light: '#F59E0B',
                            DEFAULT: '#D97706',
                            dark: '#B45309'
                        }
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 20px -5px rgba(0, 0, 0, 0.07)'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f7fafc;
        }

        .customer-card {
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .customer-card:hover {
            transform: translateY(-5px);
            border-color: #4338CA;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-active {
            background-color: #10B981;
            box-shadow: 0 0 8px #10B981;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
<div class="flex">
    <!-- Sidebar -->
    <aside th:replace="~{admin_html/fragment/sidebar :: sidebar}"></aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto">
        <div class="container mx-auto px-6 py-8">
            <!-- Header Section -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Quản Lý Khách Hàng</h1>
                    <p class="text-gray-600 mt-1" th:text="'Tổng số: ' + ${customerPage.totalElements} + ' khách hàng'"></p>
                </div>
            </div>


            <!-- Filter Section -->
            <form method="get" th:action="@{/admin/customers}" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Bộ Lọc Tìm Kiếm</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <!-- Search Field -->
                    <div class="md:col-span-2">
                        <label for="searchCustomer" class="block text-sm font-medium text-gray-700 mb-1.5">Tìm kiếm khách hàng</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="searchCustomer" name="searchQuery" th:value="${searchQuery}" placeholder="Nhập tên, email, số điện thoại..."
                                   class="pl-10 w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-light filter-input">
                        </div>
                    </div>

                    <!-- Gender -->
                    <div>
                        <label for="filterGender" class="block text-sm font-medium text-gray-700 mb-1.5">Giới tính</label>
                        <div class="relative">
                            <select id="filterGender" name="gender"
                                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-light filter-input appearance-none">
                                <option value="">Tất cả giới tính</option>
                                <option value="Nam" th:selected="${gender == 'Nam'}">Nam</option>
                                <option value="Nữ" th:selected="${gender == 'Nữ'}">Nữ</option>
                                <option value="OTHER" th:selected="${gender == 'OTHER'}">Khác</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Age Range -->
                    <div>
                        <label for="filterAgeRange" class="block text-sm font-medium text-gray-700 mb-1.5">Độ tuổi</label>
                        <div class="relative">
                            <select id="filterAgeRange" name="ageRange"
                                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-light filter-input appearance-none">
                                <option value="">Tất cả độ tuổi</option>
                                <option value="0-18" th:selected="${ageRange == '0-18'}">Dưới 18</option>
                                <option value="18-25" th:selected="${ageRange == '18-25'}">18 - 25</option>
                                <option value="26-35" th:selected="${ageRange == '26-35'}">26 - 35</option>
                                <option value="36-50" th:selected="${ageRange == '36-50'}">36 - 50</option>
                                <option value="51-999" th:selected="${ageRange == '51-999'}">Trên 50</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Registration Date -->
                    <div>
                        <label for="filterRegistrationDate" class="block text-sm font-medium text-gray-700 mb-1.5">Ngày đăng ký</label>
                        <div class="relative">
                            <select id="filterRegistrationDate" name="registrationDate"
                                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-light filter-input appearance-none">
                                <option value="">Tất cả thời gian</option>
                                <option value="today" th:selected="${registrationDate == 'today'}">Hôm nay</option>
                                <option value="week" th:selected="${registrationDate == 'week'}">Tuần này</option>
                                <option value="month" th:selected="${registrationDate == 'month'}">Tháng này</option>
                                <option value="year" th:selected="${registrationDate == 'year'}">Năm nay</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-end space-x-3">
                         <button type="submit" class="w-full bg-primary hover:bg-primary-dark text-white py-2.5 px-4 rounded-lg font-medium transition-colors duration-300">
                            Áp dụng
                        </button>
                        <a th:href="@{/admin/customers(page=0, size=8)}" class="w-full text-center bg-gray-200 hover:bg-gray-300 text-gray-800 py-2.5 px-4 rounded-lg font-medium transition-colors duration-300">
                            Đặt lại
                        </a>
                    </div>
                </div>
                <input type="hidden" name="page" th:value="${currentPage}">
                <input type="hidden" name="size" th:value="${customerPage.size}">
            </form>


            <!-- Customers Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" th:if="${!customerPage.empty}" id="customersGrid">
                <!-- Customer Cards -->
                <div th:each="customer : ${customerPage.content}"
                     class="customer-card bg-white rounded-2xl flex flex-col overflow-hidden shadow-card hover:shadow-card-hover">

                    <!-- Card Body -->
                    <div class="p-6 flex flex-col flex-1">
                        <div class="flex items-center mb-4">
                             <div class="relative flex-shrink-0">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-2xl shadow-md"
                                     th:text="${#strings.substring(customer.full_name, 0, 1).toUpperCase()}"></div>
                                <div class="absolute bottom-0 right-0 status-dot status-active" title="Hoạt động"></div>
                            </div>
                            <div class="ml-4 flex-1">
                                <h3 class="text-lg font-bold text-gray-900" th:text="${customer.full_name}"></h3>
                                <p class="text-sm text-gray-500" th:text="${customer.email}"></p>
                            </div>
                        </div>

                        <!-- Rank Info -->
                        <div class="bg-gray-50 rounded-xl p-4 mb-5">
                             <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-xs text-gray-500 font-medium">Hạng thành viên</p>
                                    <p class="text-base font-bold text-gray-800" th:text="${customer.rank != null ? customer.rank.rank : 'Chưa có'}"></p>
                                </div>
                                <div th:with="rankName=${customer.rank != null ? customer.rank.rank : ''}">
                                    <i th:if="${#strings.contains(rankName, 'Đồng')}" class="fas fa-medal text-yellow-600 text-2xl opacity-70"></i>
                                    <i th:if="${#strings.contains(rankName, 'Bạc')}" class="fas fa-medal text-gray-400 text-2xl"></i>
                                    <i th:if="${#strings.contains(rankName, 'Vàng')}" class="fas fa-medal text-yellow-400 text-2xl"></i>
                                    <i th:if="${rankName == '' or #strings.contains(rankName, 'Chưa có')}" class="fas fa-question-circle text-gray-400 text-2xl"></i>
                                </div>
                            </div>
                            <p class="text-right text-sm text-gray-600 mt-2">
                                <span class="font-bold" th:text="${customer.rank != null ? customer.rank.points : 0}"></span>
                                <span>điểm</span>
                            </p>
                        </div>
                        
                        <!-- Details -->
                        <div class="text-sm space-y-3 text-gray-600">
                             <div class="flex items-center">
                                <i class="fas fa-phone-alt w-5 text-center mr-3 text-gray-400"></i>
                                <span th:text="${customer.phone_number ?: 'Chưa có SĐT'}"></span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-birthday-cake w-5 text-center mr-3 text-gray-400"></i>
                                <span th:if="${customer.date_of_birth != null}"
                                      th:text="${#temporals.format(customer.date_of_birth, 'dd/MM/yyyy')}"></span>
                                <span th:unless="${customer.date_of_birth != null}">Chưa có ngày sinh</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-calendar-alt w-5 text-center mr-3 text-gray-400"></i>
                                <span>Tham gia ngày <span th:text="${#temporals.format(customer.created_at, 'dd/MM/yyyy')}"></span></span>
                            </div>
                        </div>

                    </div>
                    
                    <!-- Card Footer -->
                    <div class="bg-gray-50/70 p-4 mt-auto">
                        <a th:href="@{'/admin/customers/customer_detail/' + ${customer.user_id}}"
                           class="w-full text-center block bg-primary hover:bg-primary-dark text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center shadow-lg shadow-primary-light/50">
                            <span>Xem Chi Tiết</span>
                            <i class="fas fa-arrow-right ml-2"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div th:if="${customerPage.empty}" class="col-span-full rounded-xl p-8 text-center bg-gray-50">
                <div class="mx-auto w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 mb-4">
                    <i class="fas fa-users text-3xl"></i>
                </div>
                <h3 class="text-xl font-medium text-gray-900 mb-2">Không có khách hàng nào</h3>
                <p class="text-gray-500 max-w-md mx-auto">Không tìm thấy khách hàng nào phù hợp với tiêu chí lọc của bạn.</p>
            </div>

            <!-- Pagination -->
            <div th:if="${customerPage.totalPages > 1}" class="flex justify-center mt-8">
                <nav class="inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <a th:href="@{/admin/customers(page=${currentPage - 1}, size=${customerPage.size}, searchQuery=${searchQuery}, gender=${gender}, ageRange=${ageRange}, registrationDate=${registrationDate})}"
                       th:classappend="${customerPage.first ? 'pointer-events-none text-gray-300 bg-gray-100' : 'text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <a th:each="i : ${#numbers.sequence(0, customerPage.totalPages - 1)}"
                       th:href="@{/admin/customers(page=${i}, size=${customerPage.size}, searchQuery=${searchQuery}, gender=${gender}, ageRange=${ageRange}, registrationDate=${registrationDate})}"
                       th:classappend="${i == currentPage ? 'z-10 bg-primary-light border-primary-light text-white' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-4 py-2 border text-sm font-medium"
                       th:text="${i + 1}">
                    </a>
                    <a th:href="@{/admin/customers(page=${currentPage + 1}, size=${customerPage.size}, searchQuery=${searchQuery}, gender=${gender}, ageRange=${ageRange}, registrationDate=${registrationDate})}"
                       th:classappend="${customerPage.last ? 'pointer-events-none text-gray-300 bg-gray-100' : 'text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </nav>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to set filter values based on URL parameters
        function setFiltersFromURL() {
            const params = new URLSearchParams(window.location.search);
            document.getElementById('searchCustomer').value = params.get('searchQuery') || '';
            document.getElementById('filterGender').value = params.get('gender') || '';
            document.getElementById('filterAgeRange').value = params.get('ageRange') || '';
            document.getElementById('filterRegistrationDate').value = params.get('registrationDate') || '';
        }

        // Apply filters when the form is submitted or filter is changed
        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            const params = new URLSearchParams();

            const searchQuery = document.getElementById('searchCustomer').value;
            if (searchQuery) params.append('searchQuery', searchQuery);

            const gender = document.getElementById('filterGender').value;
            if (gender) params.append('gender', gender);

            const ageRange = document.getElementById('filterAgeRange').value;
            if (ageRange) params.append('ageRange', ageRange);

            const registrationDate = document.getElementById('filterRegistrationDate').value;
            if (registrationDate) params.append('registrationDate', registrationDate);

            // Always reset page to 0 and ensure size is present when applying new filters
            params.append('page', '0'); 
            params.append('size', '8'); 

            window.location.href = window.location.pathname + '?' + params.toString();
        });

        // Reset filters
        document.querySelector('a[href="/admin/customers(page=0, size=8)"]').addEventListener('click', function(event) {
            event.preventDefault();
            window.location.href = this.href;
        });


        // Set initial state on page load
        setFiltersFromURL();
    });
</script>
</body>
</html>