<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Người dùng - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#4F46E5',
                            DEFAULT: '#4338CA',
                            dark: '#3730A3'
                        },
                        secondary: {
                            light: '#10B981',
                            DEFAULT: '#059669',
                            dark: '#047857'
                        },
                        accent: {
                            light: '#F59E0B',
                            DEFAULT: '#D97706',
                            dark: '#B45309'
                        }
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 20px -5px rgba(0, 0, 0, 0.07)'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
        }
        .status-dot {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            border: 4px solid white;
        }
        .status-active {
            background-color: #22c55e; /* green-500 */
        }
        .status-inactive {
            background-color: #6b7280; /* gray-500 */
        }
        .dropdown-menu {
            display: none;
        }
        .dropdown-menu.show {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
<div class="flex">
    <!-- Sidebar -->
    <aside th:replace="~{admin_html/fragment/sidebar :: sidebar}"></aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header Section -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Chi tiết Khách hàng</h1>
                    <div class="flex items-center mt-3 text-lg">
                        <span class="text-gray-500">Username:</span>
                        <span class="font-semibold ml-2 text-gray-800" th:text="${customer.username}"></span>
                        <span th:if="${customer.rank != null && customer.rank.rank == 'Đã chấm dứt'}"
                              class="ml-4 text-sm inline-flex items-center font-bold leading-sm uppercase px-3 py-1 bg-red-200 text-red-700 rounded-full">
                            <i class="fas fa-times-circle mr-1"></i>
                            <span>Đã chấm dứt</span>
                        </span>
                        <span th:unless="${customer.rank != null && customer.rank.rank == 'Đã chấm dứt'}"
                              class="ml-4 text-sm inline-flex items-center font-bold leading-sm uppercase px-3 py-1 bg-green-200 text-green-700 rounded-full">
                            <i class="fas fa-check-circle mr-1"></i>
                            <span>Đang hoạt động</span>
                        </span>
                    </div>
                </div>
                <div class="mt-4 md:mt-0">
                    <a href="/admin/customers" class="px-5 py-2.5 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 flex items-center font-medium transition">
                        <i class="fas fa-arrow-left mr-2"></i> Quay lại
                    </a>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="lg:col-span-1 flex flex-col space-y-8">
                    <!-- Profile Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                        <div class="relative w-32 h-32 mx-auto mb-4">
                            <div class="w-full h-full rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-5xl shadow-md"
                                 th:text="${#strings.substring(customer.full_name, 0, 1).toUpperCase()}"></div>
                            <div class="absolute bottom-1 right-1 w-6 h-6 border-4 border-white rounded-full status-dot"
                                 th:classappend="${customer.rank != null && customer.rank.rank == 'Đã chấm dứt'} ? 'status-inactive' : 'status-active'"
                                 th:title="${customer.rank != null && customer.rank.rank == 'Đã chấm dứt'} ? 'Đã chấm dứt' : 'Hoạt động'"></div>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900" th:text="${customer.full_name}"></h2>
                        <p class="text-base text-gray-500 mt-1" th:text="${customer.email}"></p>

                        <div class="mt-6 grid grid-cols-3 gap-4">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-indigo-600" th:text="${#lists.size(bookings)}"></p>
                                <p class="text-sm text-gray-500">Tours đã đi</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-indigo-600" th:text="${customer.rank != null ? customer.rank.points : 0}"></p>
                                <p class="text-sm text-gray-500">Điểm</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-indigo-600" th:text="${customer.rank != null ? customer.rank.rank : '---'}"></p>
                                <p class="text-sm text-gray-500">Hạng</p>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-cog text-gray-500 mr-3"></i>Hành động
                        </h3>
                        <form id="terminateForm" th:action="@{/admin/customers/{id}/terminate(id=${customer.user_id})}" method="post">
                            <button id="openModalBtn" type="button" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center font-medium">
                                <i class="fas fa-user-slash mr-2"></i>
                                Chấm dứt Tư cách Thành viên
                            </button>
                        </form>
                    </div>

                     <!-- Info Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-info-circle text-indigo-500 mr-3"></i>Thông tin Chi tiết
                        </h3>
                        <div class="space-y-5 text-base">
                             <div class="flex items-start">
                                <i class="fas fa-venus-mars w-6 mt-1 text-center text-gray-400"></i>
                                <div class="ml-4">
                                    <p class="text-gray-500">Giới tính</p>
                                    <p class="font-semibold text-gray-800" th:text="${customer.gender ?: 'Chưa cập nhật'}"></p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-birthday-cake w-6 mt-1 text-center text-gray-400"></i>
                                <div class="ml-4">
                                    <p class="text-gray-500">Ngày sinh</p>
                                    <p class="font-semibold text-gray-800" th:text="${customer.date_of_birth != null ? #temporals.format(customer.date_of_birth, 'dd/MM/yyyy') : 'Chưa cập nhật'}"></p>
                                </div>
                            </div>
                             <div class="flex items-start">
                                <i class="fas fa-phone-alt w-6 mt-1 text-center text-gray-400"></i>
                                <div class="ml-4">
                                    <p class="text-gray-500">Số điện thoại</p>
                                    <p class="font-semibold text-gray-800" th:text="${customer.phone_number ?: 'Chưa cập nhật'}"></p>
                                </div>
                            </div>
                             <div class="flex items-start">
                                <i class="fas fa-map-marker-alt w-6 mt-1 text-center text-gray-400"></i>
                                <div class="ml-4">
                                    <p class="text-gray-500">Địa chỉ</p>
                                    <p class="font-semibold text-gray-800" th:text="${customer.address ?: 'Chưa cập nhật'}"></p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-calendar-plus w-6 mt-1 text-center text-gray-400"></i>
                                <div class="ml-4">
                                    <p class="text-gray-500">Ngày tham gia</p>
                                    <p class="font-semibold text-gray-800" th:text="${#temporals.format(customer.created_at, 'dd/MM/yyyy')}"></p>
                                </div>
                            </div>
                        </div>
                     </div>
                </div>

                <!-- Right Column -->
                <div class="lg:col-span-2 flex flex-col space-y-8">
                     <!-- History Sections -->
                    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Lịch sử Điểm</h2>
                        <div th:if="${!pointHistory.empty}" class="relative border-l-2 border-gray-200 ml-3">
                            <div th:each="entry : ${pointHistory}" class="mb-8 ml-6">
                                <span th:classappend="${entry.type.name() == 'ADDITION' ? 'bg-green-500' : 'bg-red-500'}" class="absolute flex items-center justify-center w-6 h-6 rounded-full -left-3 ring-8 ring-white">
                                    <i th:if="${entry.type.name() == 'ADDITION'}" class="fas fa-plus text-white text-xs"></i>
                                    <i th:if="${entry.type.name() == 'REDEMPTION'}" class="fas fa-minus text-white text-xs"></i>
                                </span>
                                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                    <div class="items-center justify-between sm:flex">
                                        <time class="mb-1 text-sm font-normal text-gray-500 sm:order-last sm:mb-0" th:text="${#temporals.format(entry.creationDate, 'HH:mm, dd/MM/yyyy')}"></time>
                                        <div class="text-base font-medium text-gray-700">
                                            <span class="font-semibold text-gray-900" th:text="${entry.description}"></span>
                                        </div>
                                    </div>
                                     <div class="mt-2 text-base font-semibold" th:classappend="${entry.type.name() == 'ADDITION' ? 'text-green-600' : 'text-red-600'}">
                                        <span th:text="${entry.type.name() == 'ADDITION' ? '+' : ''}"></span>
                                        <span th:text="${entry.pointsChange}"></span>
                                         điểm
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${pointHistory.empty}" class="bg-yellow-50 border-2 border-dashed border-yellow-200 rounded-xl p-8 text-center">
                            <div class="inline-block bg-yellow-100 p-4 rounded-full mb-4">
                                <i class="fas fa-coins text-yellow-600 text-4xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-700 mb-2">Khách hàng này chưa có lịch sử điểm tích lũy nào</h3>
                        </div>
                    </div>
                     <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Lịch sử Xếp hạng</h2>
                        <div th:if="${!rankHistory.empty}" class="relative border-l-2 border-gray-200 ml-3">
                             <div th:each="entry : ${rankHistory}" class="mb-8 ml-6">
                                <span class="absolute flex items-center justify-center w-6 h-6 bg-blue-500 rounded-full -left-3 ring-8 ring-white">
                                    <i class="fas fa-award text-white text-xs"></i>
                                </span>
                                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                   <div class="items-center justify-between sm:flex">
                                        <time class="mb-1 text-sm font-normal text-gray-500 sm:order-last sm:mb-0" th:text="${#temporals.format(entry.promotionDate, 'dd/MM/yyyy')}"></time>
                                        <div class="text-base font-medium text-gray-700">
                                             <span class="font-semibold text-gray-900" th:text="${entry.description}"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-base">
                                         Hạng cũ: <span class="font-semibold" th:text="${entry.oldRank}"></span> -> Hạng mới: <span class="font-semibold" th:text="${entry.newRank}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${rankHistory.empty}" class="bg-purple-50 border-2 border-dashed border-purple-200 rounded-xl p-8 text-center">
                            <div class="inline-block bg-purple-100 p-4 rounded-full mb-4">
                                <i class="fas fa-award text-purple-600 text-4xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-700 mb-2">Khách hàng này chưa có lịch sử xếp hạng nào</h3>
                        </div>
                    </div>

                    <!-- Bookings Section -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mt-8 md:p-8">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Tour đã đi</h2>
                        </div>
        
                        <div id="all-tab">
                            <div class="flex flex-col gap-4">
                                <!-- Booking List Item -->
                                <div th:each="booking : ${bookings}" class="flex flex-col sm:flex-row items-center bg-white p-4 rounded-xl border border-gray-200 hover:border-indigo-500 hover:shadow-lg transition-all duration-300">
                                    <div class="flex-1 w-full">
                                        <div class="flex justify-between items-start">
                                             <a th:href="'/admin/tourBookings/detail/'+ ${booking.getBooking_id()}" class="font-bold text-lg text-gray-800 hover:text-indigo-600" th:text="${booking.tour_name}"></a>
                                            <span th:classappend="${(booking.status == 'Pending payment') ? 'bg-amber-100 text-amber-800' :
                                                  (booking.status == 'Paid') ? 'bg-green-100 text-green-800' :
                                                  (booking.status == 'Cash') ? 'bg-blue-100 text-blue-800' :
                                                  (booking.status == 'Cancelled') ? 'bg-red-100 text-red-800' :
                                                  (booking.status == 'Completed') ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}"
                                                  class="px-3 py-1 rounded-full text-xs font-semibold uppercase">
                                                <span th:text="${booking.status.replace('_', ' ')}"></span>
                                            </span>
                                        </div>
                                        <div class="mt-2 flex items-center text-sm text-gray-500">
                                            <i class="fas fa-hashtag text-gray-400 mr-2"></i>
                                            <span th:text="'Mã đơn: ' + ${booking.booking_id}"></span>
                                        </div>
                                    </div>
                                    <div class="w-full sm:w-auto flex sm:flex-col items-center justify-between sm:items-end mt-4 sm:mt-0 sm:ml-6 text-right">
                                        <p class="text-xl font-bold text-indigo-600" th:text="${#numbers.formatInteger(booking.total_price, 3, 'POINT') + '₫'}"></p>
                                        <a th:href="'/admin/tourBookings/detail/'+ ${booking.getBooking_id()}"
                                           class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center text-sm font-medium">
                                            <i class="fas fa-info-circle mr-2"></i>
                                            <span>Chi tiết</span>
                                        </a>
                                    </div>
                                </div>
        
                                <!-- Empty State -->
                                <div th:if="${bookings.empty}" class="bg-blue-50 border-2 border-dashed border-blue-200 rounded-xl p-8 text-center">
                                    <div class="inline-block bg-blue-100 p-4 rounded-full mb-4">
                                        <i class="fas fa-suitcase text-blue-600 text-4xl"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-700 mb-2">Khách hàng này chưa có đơn đặt tour nào</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Termination Confirmation Modal -->
        <div id="terminationModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 w-full max-w-md mx-4">
                <div class="sm:flex sm:items-start">
                    <div class="flex-shrink-0 mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Xác nhận Chấm dứt Tư cách
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-600">
                                Bạn có chắc chắn muốn chấm dứt tư cách thành viên của khách hàng này không?
                                <br>
                                Hành động này <strong>không thể hoàn tác</strong> và sẽ đặt lại điểm của họ về 0.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-6 sm:flex sm:flex-row-reverse">
                    <button id="confirmTerminateBtn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Xác nhận
                    </button>
                    <button id="cancelTerminateBtn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                        Hủy bỏ
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('terminationModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const cancelBtn = document.getElementById('cancelTerminateBtn');
        const confirmBtn = document.getElementById('confirmTerminateBtn');
        const terminateForm = document.getElementById('terminateForm');

        if (openModalBtn) {
            openModalBtn.addEventListener('click', () => {
                if (modal) modal.classList.remove('hidden');
            });
        }

        function closeModal() {
            if (modal) modal.classList.add('hidden');
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', closeModal);
        }
        
        if (modal) {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal();
                }
            });
        }

        if (confirmBtn && terminateForm) {
            confirmBtn.addEventListener('click', () => {
                terminateForm.submit();
            });
        }
    });
</script>
</body>
</html>