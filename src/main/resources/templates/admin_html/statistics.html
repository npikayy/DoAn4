<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống Kê - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .stat-card {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .chart-container {
            position: relative;
            height: 350px;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
<div class="flex min-h-screen relative">
    <!-- Sidebar -->
    <aside th:replace="~{admin_html/fragment/sidebar :: sidebar}"></aside>

    <!-- Main Content -->
    <div class="flex-1 p-8 ml-[18.5rem]">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Bảng điều khiển Thống Kê</h1>
            <p class="text-gray-500 mt-1">Tổng quan về hoạt động của hệ thống.</p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Users Card -->
            <div class="stat-card bg-white p-6 rounded-xl shadow-md border-b-blue-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Tổng khách hàng</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2" th:text="${users.size()}">0</h3>
                    </div>
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-users fa-lg"></i>
                    </div>
                </div>
            </div>

            <!-- Total Tours Card -->
            <div class="stat-card bg-white p-6 rounded-xl shadow-md border-b-green-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Tổng tour</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2" th:text="${tours.size()}">0</h3>
                    </div>
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-map-marked-alt fa-lg"></i>
                    </div>
                </div>
            </div>

            <!-- Total Bookings Card -->
            <div class="stat-card bg-white p-6 rounded-xl shadow-md border-b-purple-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Tổng đặt tour</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2" th:text="${AllBookings.size()}">0</h3>
                    </div>
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <i class="fas fa-calendar-check fa-lg"></i>
                    </div>
                </div>
            </div>

            <!-- Total Revenue Card -->
            <div class="stat-card bg-white p-6 rounded-xl shadow-md border-b-yellow-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Tổng doanh thu</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2" th:text="${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">0 VNĐ</h3>
                    </div>
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i class="fas fa-dollar-sign fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Combined Chart -->
            <div class="bg-white rounded-lg shadow-sm p-5">
                <div class="card-header mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-chart-line text-blue-500 mr-2"></i>
                        Doanh thu & Đặt tour
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="combinedChart"></canvas>
                </div>
            </div>

            <!-- Ratings Chart -->
            <div class="bg-white rounded-lg shadow-sm p-5">
                <div class="card-header mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-star-half-alt text-yellow-500 mr-2"></i>
                        Phân bổ đánh giá
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="ratingsChart"></canvas>
                </div>
            </div>

            <!-- User Growth Chart -->
            <div class="bg-white rounded-lg shadow-sm p-5">
                <div class="card-header mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-user-plus text-purple-500 mr-2"></i>
                        Tăng trưởng người dùng
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="userGrowthChart"></canvas>
                </div>
            </div>

            <!-- Popular Tours Chart -->
            <div class="bg-white rounded-lg shadow-sm p-5">
                <div class="card-header mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-trophy text-red-500 mr-2"></i>
                        Tour phổ biến
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="popularToursChart"></canvas>
                </div>
            </div>
            <!-- Booking Status Chart -->
            <div class="bg-white rounded-lg shadow-sm p-5">
                <div class="card-header mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-pie-chart text-green-500 mr-2"></i>
                        Phân bổ trạng thái đặt tour
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="bookingStatusChart"></canvas>
                </div>
            </div>

            <!-- Gender Chart -->
            <div class="bg-white rounded-lg shadow-sm p-5">
                <div class="card-header mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-venus-mars text-pink-500 mr-2"></i>
                        Phân bổ giới tính
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>

            <!-- Age Range Chart -->
            <div class="bg-white rounded-lg shadow-sm p-5">
                <div class="card-header mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-birthday-cake text-orange-500 mr-2"></i>
                        Phân bổ độ tuổi
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="ageRangeChart"></canvas>
                </div>
            </div>
        </div>


    </div>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const userGrowth = /*[[${userGrowth}]]*/ [];
        // Chart options configuration
        const chartOptions = {
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: '#fff',
                    titleColor: '#333',
                    bodyColor: '#666',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    padding: 15,
                    displayColors: false,
                    yAlign: 'bottom',
                    xAlign: 'center',
                    cornerRadius: 6,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    },
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false,
                    },
                    ticks: {
                        font: {
                            family: "'Inter', sans-serif"
                        }
                    }
                },
                y: {
                    grid: {
                        color: '#e5e7eb',
                        borderDash: [5, 5]
                    },
                    ticks: {
                        font: {
                            family: "'Inter', sans-serif"
                        }
                    }
                }
            },
            elements: {
                line: {
                    tension: 0.4
                },
                bar: {
                    borderRadius: 4
                }
            }
        };

        // Combined Chart
        const combinedCtx = document.getElementById('combinedChart').getContext('2d');
        if (combinedCtx) {
            const gradient = combinedCtx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

            new Chart(combinedCtx, {
                type: 'bar',
                data: {
                    labels: /*[[${monthLabels}]]*/ [],
                    datasets: [
                        {
                            label: 'Doanh thu',
                            data: /*[[${revenueData}]]*/ [],
                            backgroundColor: gradient,
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            yAxisID: 'y',
                        },
                        {
                            label: 'Số đặt tour',
                            data: /*[[${bookingCountData}]]*/ [],
                            type: 'line',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            yAxisID: 'y1',
                            pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                            pointRadius: 5
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y1: {
                           display: false
                        }
                    }
                }
            });
        }

        // Ratings Chart
        const ratingsCtx = document.getElementById('ratingsChart').getContext('2d');
        if (ratingsCtx) {
            new Chart(ratingsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['1 sao', '2 sao', '3 sao', '4 sao', '5 sao'],
                    datasets: [{
                        data: [
                            /*[[${rating1}]]*/ 0,
                            /*[[${rating2}]]*/ 0,
                            /*[[${rating3}]]*/ 0,
                            /*[[${rating4}]]*/ 0,
                            /*[[${rating5}]]*/ 0
                        ],
                        backgroundColor: [
                            '#ef4444',
                            '#f97316',
                            '#f59e0b',
                            '#3b82f6',
                            '#10b981'
                        ],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    ...chartOptions,
                    cutout: '75%',
                     plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    }
                }
            });
        }

        // User Growth Chart
        const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
        if (userGrowthCtx) {
            const userGrowthData = /*[[${userGrowth}]]*/ [];
            const growthLabels = userGrowthData.map(item => {
                const monthNames = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4",
                    "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8",
                    "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];
                return `${monthNames[item[1] - 1]}/${item[0]}`;
            });
            const growthValues = userGrowthData.map(item => item[2]);
            const userGradient = userGrowthCtx.createLinearGradient(0, 0, 0, 400);
            userGradient.addColorStop(0, 'rgba(139, 92, 246, 0.5)');
            userGradient.addColorStop(1, 'rgba(139, 92, 246, 0)');

            new Chart(userGrowthCtx, {
                type: 'line',
                data: {
                    labels: growthLabels,
                    datasets: [{
                        label: 'Số người dùng mới',
                        data: growthValues,
                        borderColor: 'rgba(139, 92, 246, 1)',
                        backgroundColor: userGradient,
                        fill: true
                    }]
                },
                options: chartOptions
            });
        }

        // Popular Tours Chart
        const popularToursCtx = document.getElementById('popularToursChart').getContext('2d');
        if (popularToursCtx) {
            new Chart(popularToursCtx, {
                type: 'bar',
                data: {
                    labels: /*[[${popularToursLabels}]]*/ [],
                    datasets: [{
                        label: 'Số đặt tour',
                        data: /*[[${popularToursValues}]]*/ [],
                        backgroundColor: '#f59e0b',
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    scales: {
                        x: { // Quantitative scale for counts (horizontal)
                            beginAtZero: true,
                            grid: {
                                display: true, // Ensure grid is visible
                                color: '#e5e7eb',
                                borderDash: [5, 5]
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        y: { // Categorical scale for tour names (vertical)
                            grid: {
                                display: false // No horizontal grid lines
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif"
                                }
                            }
                        }
                    },
                    plugins: {
                        ...chartOptions.plugins,
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#000',
                            font: {
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                return value;
                            }
                        }
                    }
                }
            });
        }
        
        // Booking Status Chart
        const bookingStatusCtx = document.getElementById('bookingStatusChart').getContext('2d');
        if (bookingStatusCtx) {
            new Chart(bookingStatusCtx, {
                type: 'pie',
                data: {
                    labels: /*[[${statusLabels}]]*/ [],
                    datasets: [{
                        data: /*[[${statusData}]]*/ [],
                        backgroundColor: [
                            '#ef4444',
                            '#f97316',
                            '#f59e0b',
                            '#3b82f6',
                            '#10b981',
                            '#6b7280'
                        ],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                 options: {
                    ...chartOptions,
                     plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    }
                }
            });
        }

        // Gender Chart
        const genderCtx = document.getElementById('genderChart').getContext('2d');
        if (genderCtx) {
            new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: /*[[${genderLabels}]]*/ [],
                    datasets: [{
                        data: /*[[${genderData}]]*/ [],
                        backgroundColor: [
                            '#3b82f6', // blue
                            '#ec4899', // pink
                            '#6b7280'  // gray
                        ],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                 options: {
                    ...chartOptions,
                     plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    }
                }
            });
        }

        // Age Range Chart
        const ageRangeCtx = document.getElementById('ageRangeChart').getContext('2d');
        if (ageRangeCtx) {
            new Chart(ageRangeCtx, {
                type: 'bar',
                data: {
                    labels: /*[[${ageRangeLabels}]]*/ [],
                    datasets: [{
                        label: 'Số lượng người dùng',
                        data: /*[[${ageRangeData}]]*/ [],
                        backgroundColor: '#f97316',
                    }]
                },
                options: {
                    ...chartOptions, // Inherit global options
                    plugins: {
                        ...chartOptions.plugins, // Keep existing plugins like tooltip
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#000', // Color of the labels
                            font: {
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                return value; // Display the raw value
                            }
                        }
                    },
                    scales: {
                        x: { // Categorical scale for age labels
                            grid: {
                                display: false // No vertical grid lines
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        y: { // Quantitative scale for counts
                            beginAtZero: true,
                            grid: {
                                display: true, // Ensure grid is visible
                                color: '#e5e7eb',
                                borderDash: [5, 5]
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif"
                                }
                            }
                        }
                    }
                }
            });
        }
    });
</script>
</body>
</html>