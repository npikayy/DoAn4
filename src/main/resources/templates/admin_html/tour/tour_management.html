<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Tour - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f3f4f6;
        }

        .tour-card {
            transition: all 0.3s ease;
        }
        .tour-card:hover {
            transform: translateY(-5px);
        }

        .badge {
            transition: all 0.2s ease;
        }

        .filter-input:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .hidden-card {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
<div class="flex">
    <!-- Sidebar -->
    <aside th:replace="~{admin_html/fragment/sidebar :: sidebar}"></aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto">
        <div class="container mx-auto px-6 py-8">
            <!-- Header Section -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Quản Lý Tour Du Lịch</h1>
                    <p class="text-gray-600 mt-1">
                        <span th:text="${tourPage.totalElements}"></span> tour được tìm thấy
                    </p>
                </div>
                <div class="mt-4 md:mt-0 flex gap-3">
                    <a href="/admin/tours/addTourDomestic" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium transition-colors duration-300 shadow-sm flex items-center">
                        <i class="fas fa-map-marked-alt mr-2"></i>
                        Thêm Tour Trong Nước
                    </a>
                    <a href="/admin/tours/addTourInternational" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2.5 rounded-lg font-medium transition-colors duration-300 shadow-sm flex items-center">
                        <i class="fas fa-globe-americas mr-2"></i>
                        Thêm Tour Nước Ngoài
                    </a>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Bộ Lọc và Sắp Xếp</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-5">

                    <!-- Search Field -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Tìm kiếm tour</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="searchTourName" placeholder="Nhập tên tour, điểm đến..."
                                   class="pl-10 w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 filter-input">
                        </div>
                    </div>

                    <!-- Tour Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Loại tour</label>
                        <div class="relative">
                            <select id="filterTourType" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 filter-input appearance-none">
                                <option value="">Tất cả loại tour</option>
                                <option value="DOMESTIC">Tour trong nước</option>
                                <option value="INTERNATIONAL">Tour nước ngoài</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Region -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Khu vực</label>
                        <div class="relative">
                            <select id="filterRegion" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 filter-input appearance-none">
                                <option value="">Tất cả khu vực</option>
                                <option value="NORTH">Miền Bắc</option>
                                <option value="CENTRAL">Miền Trung</option>
                                <option value="SOUTHEAST">Miền Đông Nam Bộ</option>
                                <option value="SOUTHWEST">Miền Tây Nam Bộ</option>
                                <option value="INTERNATIONAL">Quốc tế</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Rating -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Rating</label>
                        <div class="relative">
                            <select id="filterRating" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 filter-input appearance-none">
                                <option value="">Tất cả</option>
                                <option value="5">5 sao</option>
                                <option value="4">4 sao trở lên</option>
                                <option value="3">3 sao trở lên</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Price Range -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Khoảng giá</label>
                        <div class="relative">
                            <select id="filterPriceRange" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 filter-input appearance-none">
                                <option value="">Tất cả giá</option>
                                <option value="0-1000000">Dưới 1 triệu</option>
                                <option value="1000000-3000000">1 - 3 triệu</option>
                                <option value="3000000-5000000">3 - 5 triệu</option>
                                <option value="5000000-10000000">5 - 10 triệu</option>
                                <option value="10000000-999999999">Trên 10 triệu</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Location -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Địa điểm</label>
                        <div class="relative">
                            <select id="filterLocation" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 filter-input appearance-none">
                                <option value="">Tất cả địa điểm</option>
                                <option th:each="loc : ${uniqueLocations}"
                                        th:value="${loc}"
                                        th:text="${loc}"></option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Departure Status -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Lịch khởi hành</label>
                        <div class="relative">
                            <select id="filterDepartureStatus" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 filter-input appearance-none">
                                <option value="">Tất cả</option>
                                <option value="HAS_DEPARTURE">Có lịch khởi hành</option>
                                <option value="NO_DEPARTURE">Chưa có lịch</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Promotion Status -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Trạng thái khuyến mãi</label>
                        <div class="relative">
                            <select id="filterPromotionStatus" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 filter-input appearance-none">
                                <option value="">Tất cả</option>
                                <option value="ACTIVE_PROMOTION">Đang có khuyến mãi</option>
                                <option value="UPCOMING_PROMOTION">Sắp có khuyến mãi</option>
                                <option value="EXPIRED_PROMOTION">Hết hạn khuyến mãi</option>
                                <option value="NO_PROMOTION">Không có khuyến mãi</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Redeemable with Points Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Đổi bằng điểm</label>
                        <div class="relative">
                            <select id="filterRedeemableWithPoints" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 filter-input appearance-none">
                                <option value="">Tất cả</option>
                                <option value="true">Có thể đổi</option>
                                <option value="false">Không thể đổi</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="md:col-span-2 flex items-end space-x-3">
                        <button id="applyFilters" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-4 rounded-lg font-medium transition-colors duration-300">
                            Áp dụng bộ lọc
                        </button>
                        <button id="resetFilters" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2.5 px-4 rounded-lg font-medium transition-colors duration-300">
                            Đặt lại bộ lọc
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tours Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" th:if="${!tourPage.empty}">
                <!-- Tour Card -->
                <div th:each="tour : ${tourPage.content}"
                     th:with="promotion=${tour.getDiscount_promotion()},
                              isPromotionActive=${promotion != null and #dates.createNow().after(promotion.ngayBatDau) and #dates.createNow().before(promotion.ngayKetThuc)},
                              isPromotionUpcoming=${promotion != null and #dates.createNow().before(promotion.ngayBatDau)}"
                     class="tour-card bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-all duration-300"
                     th:attr="data-name=${tour.tour_name.toLowerCase()},
                              data-type=${tour.tour_type},
                              data-region=${tour.tour_region},
                              data-destination=${tour.tour_end_location}"
                     th:data-price="${tour.tour_adult_price != null ? (isPromotionActive ? (tour.tour_adult_price * (100 - promotion.getPhanTramGiamGia()) / 100) : tour.tour_adult_price) : ''}"
                     th:data-duration="${tour.tour_duration}"
                     th:data-tour-type="${tour.tour_type}"
                     th:data-has-discount="${isPromotionActive}">
                    <a th:href="@{'/admin/tours/detail/' + ${tour.tour_id}}" class="block">
                        <!-- Tour Image -->
                        <div class="relative h-48 overflow-hidden">
                            <img th:if="${tourThumbnails.get(tour.tour_id) != null and !tourThumbnails.get(tour.tour_id).isEmpty()}"
                                 th:src="${tourThumbnails.get(tour.tour_id)}"
                                 alt="Tour image"
                                 class="w-full h-full object-cover transition-transform duration-500 hover:scale-105">
                            <img th:unless="${tourThumbnails.get(tour.tour_id) != null and !tourThumbnails.get(tour.tour_id).isEmpty()}"
                                 src="/img/default-tour.jpg"
                                 alt="Default tour image"
                                 class="w-full h-full object-cover">

                            <!-- Active Discount Badge -->
                            <div th:if="${isPromotionActive}"
                                 class="absolute top-3 right-3">
                                <span class="bg-red-500 text-white px-3 py-1 text-xs font-bold shadow-md rounded-full" th:text="${promotion.getTenKhuyenMai()}"></span>
                                <span class="bg-red-500 text-white px-3 py-1 text-xs font-bold shadow-md rounded-full " th:text="'- ' + ${promotion.getPhanTramGiamGia()} + '%'"></span>
                            </div>

                            <!-- Upcoming Promotion Badge -->
                            <div th:if="${isPromotionUpcoming}"
                                 class="absolute top-3 left-3 bg-green-500 text-white px-3 py-1 text-xs font-semibold shadow-md rounded-full">
                                <i class="fas fa-bell mr-1"></i>
                                KM sẽ bắt đầu vào: <span th:text="${#dates.format(promotion.ngayBatDau, 'dd/MM/yyyy')}"></span>
                            </div>

                            <!-- Duration Badge -->
                            <div class="absolute bottom-3 bg-white left-3 bg-white/90 text-gray-800 px-3 py-1 rounded-full text-xs font-semibold shadow-sm">
                                <i class="fas fa-clock text-blue-500 mr-1"></i>
                                <span th:text="${tour.tour_duration} + ' ngày ' + (${tour.tour_duration} - 1) + ' đêm'"></span>
                            </div>
                        </div>

                        <!-- Tour Info -->
                        <div class="p-5">
                            <!-- Tour Name -->
                            <h3 class="text-lg font-bold text-gray-800 mb-2 truncate tour-name" th:text="${tour.tour_name}"></h3>

                            <!-- Location -->
                            <div class="flex items-center text-sm text-gray-600 mb-2">
                                <i class="fas fa-map-marker-alt text-gray-500 mr-2"></i>
                                <span class="truncate" th:text="${tour.tour_end_location}"></span>
                            </div>

                            <!-- Departure Dates -->
                            <div class="mb-3">
                                <div class="flex items-center text-sm text-gray-600 mb-1">
                                    <i class="fas fa-calendar-day text-gray-500 mr-2"></i>
                                    <span class="font-medium">Ngày khởi hành:</span>
                                </div>
                                <div class="flex flex-wrap gap-1.5">
                                    <!-- Hiển thị tối đa 3 ngày -->
                                    <span th:each="date,iter : ${tourStartDates.get(tour.tour_id)}"
                                          th:if="${iter.index < 3}"
                                          class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                                        <span th:text="${#temporals.format(date.start_date, 'dd/MM')}"></span>
                                    </span>
                                    <!-- Hiển thị số lượng ngày còn lại nếu có -->
                                    <span th:if="${tourStartDates.get(tour.tour_id).size() > 3}"
                                          class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">
                                        +<span th:text="${tourStartDates.get(tour.tour_id).size() - 3}"></span> ngày khác
                                    </span>
                                    <!-- Trường hợp không có ngày khởi hành -->
                                    <span th:if="${tourStartDates.get(tour.tour_id).isEmpty()}"
                                          class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">
                                        Chưa có lịch
                                    </span>
                                </div>
                            </div>

                            <!-- Price & Rating -->
                            <div class="flex justify-between items-center mt-2 pt-3 border-t border-gray-100">
                                <div>
                                    <div th:if="${tour.tour_adult_price != null}">
                                        <!-- If promotion is active -->
                                        <div th:if="${isPromotionActive}">
                                            <div class="text-sm text-gray-400 line-through mb-1">
                                                <span th:text="${#numbers.formatInteger(tour.tour_adult_price, 3, 'POINT') + ' VND'}"></span>
                                            </div>
                                            <div class="text-blue-600 font-bold text-lg">
                                                <span th:with="discountedPrice=${tour.tour_adult_price * (100 - promotion.phanTramGiamGia) / 100}"
                                                      th:text="${#numbers.formatInteger(discountedPrice, 3, 'POINT') + ' VND'}"></span>
                                            </div>
                                        </div>
                                        <!-- If no promotion is active -->
                                        <div th:unless="${isPromotionActive}">
                                            <div class="text-blue-600 font-bold text-lg">
                                                <span th:text="${#numbers.formatInteger(tour.tour_adult_price, 3, 'POINT') + ' VND'}"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:unless="${tour.tour_adult_price != null}">
                                        <span class="text-gray-500 text-sm">Chưa cập nhật giá</span>
                                    </div>
                                </div>
                                <div class="flex items-center bg-yellow-50 text-yellow-700 px-2 py-1 rounded-full text-xs font-semibold"
                                     th:if="${tour.tour_rating != null}">
                                    <span th:text="${tour.tour_rating}"></span>
                                    <i class="fas fa-star ml-1 text-xs"></i>
                                </div>
                                <div class="flex items-center bg-yellow-50 text-yellow-700 px-2 py-1 rounded-full text-xs font-semibold"
                                     th:if="${tour.tour_rating == null}">
                                    <span>Chưa có đánh giá</span>
                                    <i class="fas fa-star ml-1 text-xs"></i>
                                </div>
                            </div>

                            <!-- Special Offer -->
                            <div th:if="${tour.special_offer != null and !tour.special_offer.isEmpty()}"
                                 class="mt-3 p-2 bg-blue-50 rounded-md text-sm text-blue-700">
                                <i class="fas fa-gift mr-1"></i>
                                <span class="font-medium">Ưu đãi:</span>
                                <span class="ml-1 truncate" th:text="${tour.special_offer}"></span>
                            </div>
                            <div th:unless="${tour.special_offer != null and !tour.special_offer.isEmpty()}"
                                 class="mt-3 p-2 bg-blue-50 rounded-md text-sm text-blue-700">
                                <i class="fas fa-gift mr-1"></i>
                                <span class="font-medium">Ưu đãi:</span>
                                <span class="ml-1 truncate">Chưa có ưu đãi</span>
                            </div>
                        </div>
                    </a>
                        </div>
                </div>
            </div>
            
            <!-- Empty State -->
            <div id="noResultsMessage" th:if="${tourPage.empty}" class="bg-white rounded-xl shadow-sm p-12 text-center">
                <div class="max-w-md mx-auto">
                    <i class="fas fa-compass text-5xl text-gray-300 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Không có tour nào được tìm thấy</h3>
                    <p class="text-gray-500 mb-6">Không có tour nào phù hợp với tiêu chí tìm kiếm của bạn.</p>
                    <button onclick="resetFilters()" class="inline-flex items-center px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Đặt lại bộ lọc
                    </button>
                </div>
            </div>

            <!-- Pagination -->
            <div th:if="${tourPage.totalPages > 1}" class="flex justify-center mt-8">
                <nav class="inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <a th:href="@{/admin/tours(page=${currentPage - 1}, size=${tourPage.size}, keyword=${keyword}, tourType=${tourType}, region=${region}, priceRange=${priceRange}, location=${location}, departureStatus=${departureStatus}, promotionStatus=${promotionStatus}, rating=${rating}, redeemableWithPoints=${redeemableWithPoints})}"
                       th:classappend="${tourPage.first ? 'pointer-events-none text-gray-300 bg-gray-100' : 'text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <a th:each="i : ${#numbers.sequence(0, tourPage.totalPages - 1)}"
                       th:href="@{/admin/tours(page=${i}, size=${tourPage.size}, keyword=${keyword}, tourType=${tourType}, region=${region}, priceRange=${priceRange}, location=${location}, departureStatus=${departureStatus}, promotionStatus=${promotionStatus}, rating=${rating}, redeemableWithPoints=${redeemableWithPoints})}"
                       th:classappend="${i == currentPage ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-4 py-2 border text-sm font-medium"
                       th:text="${i + 1}">
                    </a>
                    <a th:href="@{/admin/tours(page=${currentPage + 1}, size=${tourPage.size}, keyword=${keyword}, tourType=${tourType}, region=${region}, priceRange=${priceRange}, location=${location}, departureStatus=${departureStatus}, promotionStatus=${promotionStatus}, rating=${rating}, redeemableWithPoints=${redeemableWithPoints})}"
                       th:classappend="${tourPage.last ? 'pointer-events-none text-gray-300 bg-gray-100' : 'text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </nav>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to set filter values based on URL parameters
        function setFiltersFromURL() {
            const params = new URLSearchParams(window.location.search);
            document.getElementById('searchTourName').value = params.get('keyword') || '';
            document.getElementById('filterTourType').value = params.get('tourType') || '';
            document.getElementById('filterRegion').value = params.get('region') || '';
            document.getElementById('filterPriceRange').value = params.get('priceRange') || '';
            document.getElementById('filterRating').value = params.get('rating') || '';
            document.getElementById('filterLocation').value = params.get('location') || '';
            document.getElementById('filterDepartureStatus').value = params.get('departureStatus') || '';
            document.getElementById('filterPromotionStatus').value = params.get('promotionStatus') || '';
            document.getElementById('filterRedeemableWithPoints').value = params.get('redeemableWithPoints') || '';
        }

        // Apply filters when the button is clicked
        document.getElementById('applyFilters').addEventListener('click', function() {
            const params = new URLSearchParams();

            const keyword = document.getElementById('searchTourName').value;
            if (keyword) params.append('keyword', keyword);

            const tourType = document.getElementById('filterTourType').value;
            if (tourType) params.append('tourType', tourType);

            const region = document.getElementById('filterRegion').value;
            if (region) params.append('region', region);

            const priceRange = document.getElementById('filterPriceRange').value;
            if (priceRange) params.append('priceRange', priceRange);

            const rating = document.getElementById('filterRating').value;
            if (rating) params.append('rating', rating);

            const location = document.getElementById('filterLocation').value;
            if (location) params.append('location', location);

            const departureStatus = document.getElementById('filterDepartureStatus').value;
            if (departureStatus) params.append('departureStatus', departureStatus);

            const promotionStatus = document.getElementById('filterPromotionStatus').value;
            if (promotionStatus) params.append('promotionStatus', promotionStatus);

            const redeemableWithPoints = document.getElementById('filterRedeemableWithPoints').value;
            if (redeemableWithPoints) params.append('redeemableWithPoints', redeemableWithPoints);

            // Always reset page to 0 and ensure size is present when applying new filters
            params.append('page', '0'); 
            params.append('size', '8'); 

            window.location.href = window.location.pathname + '?' + params.toString();
        });

        // Reset filters
        document.getElementById('resetFilters').addEventListener('click', function() {
            // Reset filters and navigate to the first page with default size
            window.location.href = window.location.pathname + '?page=0&size=8';
        });

        // Set initial state on page load
        setFiltersFromURL();
    });
</script>
</body>
</html>