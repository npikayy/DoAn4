<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Khuyến mãi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
<div class="min-h-screen flex relative">
    <!-- Sidebar -->
    <aside th:replace="~{admin_html/fragment/sidebar :: sidebar}"></aside>

    <!-- Main Content -->
    <div class="flex-1 p-8 ml-[18.5rem] overflow-x-hidden overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Quản lý Khuyến mãi</h1>
            <a th:href="@{/admin/khuyen-mai/add}"
               class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg shadow-md transition-all duration-300 ease-in-out flex items-center transform hover:scale-105">
                <i class="fas fa-plus mr-2"></i> Thêm Khuyến mãi
            </a>
        </div>

        <!-- Filter Section -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Bộ lọc thông minh</h2>
            <form th:action="@{/admin/khuyen-mai}" method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Tên khuyến mãi</label>
                    <input type="text" name="name" id="name" th:value="${name}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Trạng thái</label>
                    <select name="status" id="status"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="">Tất cả</option>
                        <option value="ongoing" th:selected="${status == 'ongoing'}">Đang diễn ra</option>
                        <option value="upcoming" th:selected="${status == 'upcoming'}">Sắp diễn ra</option>
                        <option value="finished" th:selected="${status == 'finished'}">Đã kết thúc</option>
                    </select>
                </div>
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Từ ngày</label>
                    <input type="date" name="startDate" id="startDate"
                           th:value="${startDate != null ? #dates.format(startDate, 'yyyy-MM-dd') : ''}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div class="flex space-x-2">
                    <button type="submit"
                            class="w-full flex justify-center items-center bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-md transition-all duration-300 ease-in-out">
                        <i class="fas fa-filter mr-2"></i> Lọc
                    </button>
                    <a th:href="@{/admin/khuyen-mai(page=0, size=3)}"
                       class="w-full flex justify-center items-center bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow-md transition-all duration-300 ease-in-out">
                        <i class="fas fa-sync-alt mr-2"></i> Đặt lại
                    </a>
                </div>
                <!-- Hidden fields for page and size -->
                <input type="hidden" name="page" th:value="${currentPage}" />
                <input type="hidden" name="size" th:value="${khuyenMaiPage.size}" />
            </form>
        </div>

        <!-- Promotion List Section -->
        <div class="bg-white p-6 rounded-lg shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Danh sách Chương trình Khuyến mãi</h2>
                <div class="text-sm text-gray-500" th:text="'Tổng số: ' + ${khuyenMaiPage.totalElements}"></div>
            </div>

            <div th:if="${khuyenMaiPage.empty}" class="text-center py-20">
                <div class="flex flex-col items-center justify-center text-gray-500">
                    <i class="fas fa-gift text-6xl mb-4 text-gray-400"></i>
                    <h3 class="text-2xl font-semibold text-gray-700 mb-2">Chưa có chương trình khuyến mãi nào</h3>
                    <p class="text-md text-gray-500 mb-6">Hãy bắt đầu tạo chương trình khuyến mãi để thu hút khách hàng!</p>
                    <a th:href="@{/admin/khuyen-mai/add}"
                       class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i> Tạo khuyến mãi mới
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8" th:unless="${khuyenMaiPage.empty}">
                <!-- Promotion Card -->
                <div th:each="km : ${khuyenMaiPage.content}"
                     class="bg-white rounded-xl shadow-lg overflow-hidden group transform hover:shadow-xl hover:-translate-y-2 transition-all duration-300 ease-in-out">
                    <a th:href="@{/admin/khuyen-mai/edit/{id}(id=${km.id})}" class="block">
                        <div class="relative">
                            <img th:src="${km.hinhAnh != null && !km.hinhAnh.isEmpty() ? km.hinhAnh : '/img/default-tour.jpg'}"
                                 alt="Promotion Image" class="w-full h-56 object-cover">
                            <!-- Status Badge -->
                            <div class="absolute top-4 right-4 px-3 py-1 rounded-full text-sm font-semibold text-white"
                                 th:classappend="${#dates.createNow().after(km.ngayKetThuc)} ? 'bg-red-500' : (${#dates.createNow().before(km.ngayBatDau)} ? 'bg-yellow-500' : 'bg-green-500')"
                                 th:text="${#dates.createNow().after(km.ngayKetThuc)} ? 'Đã kết thúc' : (${#dates.createNow().before(km.ngayBatDau)} ? 'Sắp diễn ra' : 'Đang hoạt động')">
                            </div>
                            <!-- Discount Badge -->
                            <div class="absolute bottom-0 left-0 bg-rose-500 text-white text-lg font-bold px-4 py-2 rounded-tr-xl shadow-md">
                                <i class="fas fa-tag mr-1"></i>
                                <span th:text="'Giảm ' + ${km.phanTramGiamGia} + '%'"></span>
                            </div>
                        </div>
                        <div class="p-5 flex flex-col justify-between h-full">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800 mb-2 truncate" th:text="${km.tenKhuyenMai}"></h3>
                                <p class="text-gray-600 text-sm mb-4 h-12 overflow-hidden" th:text="${km.moTa}"></p>

                                <div class="space-y-3 text-sm mb-4">
                                    <div class="flex items-center text-gray-700">
                                        <i class="fas fa-calendar-alt w-5 mr-3 text-indigo-500"></i>
                                        <span class="font-semibold">Thời gian:</span>
                                        <span class="ml-2" th:text="${#dates.format(km.ngayBatDau, 'dd/MM/yyyy')} + ' - ' + ${#dates.format(km.ngayKetThuc, 'dd/MM/yyyy')}"></span>
                                    </div>
                                    <div class="flex items-center text-gray-700">
                                        <i class="fas fa-suitcase-rolling w-5 mr-3 text-indigo-500"></i>
                                        <span class="font-semibold">Số tour áp dụng:</span>
                                        <span class="ml-2 font-bold text-indigo-600" th:text="${#lists.size(km.tours)}"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <h4 class="text-md font-semibold text-gray-800 mb-2">Các tour áp dụng:</h4>
                                <ul class="text-sm text-gray-600 space-y-1 h-12 overflow-hidden">
                                    <li th:each="tour, iter : ${km.tours}" th:if="${iter.index < 2}" class="truncate">
                                        <i class="fas fa-tag text-xs mr-2 text-gray-400"></i>
                                        <span th:text="${tour.tour_name}"></span>
                                    </li>
                                </ul>
                                <div th:if="${#lists.size(km.tours) > 2}" class="text-xs text-gray-500 mt-2">
                                    <p>...và <span th:text="${#lists.size(km.tours) - 2}"></span> tour khác.</p>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Pagination -->
            <div th:if="${khuyenMaiPage.totalPages > 1}" class="flex justify-center mt-8">
                <nav class="inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <a th:href="@{/admin/khuyen-mai(page=${currentPage - 1}, size=${khuyenMaiPage.size}, name=${name}, status=${status}, startDate=${startDate}, endDate=${endDate})}"
                       th:classappend="${khuyenMaiPage.first ? 'pointer-events-none text-gray-300 bg-gray-100' : 'text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <a th:each="i : ${#numbers.sequence(0, khuyenMaiPage.totalPages - 1)}"
                       th:href="@{/admin/khuyen-mai(page=${i}, size=${khuyenMaiPage.size}, name=${name}, status=${status}, startDate=${startDate}, endDate=${endDate})}"
                       th:classappend="${i == currentPage ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-4 py-2 border text-sm font-medium"
                       th:text="${i + 1}">
                    </a>
                    <a th:href="@{/admin/khuyen-mai(page=${currentPage + 1}, size=${khuyenMaiPage.size}, name=${name}, status=${status}, startDate=${startDate}, endDate=${endDate})}"
                       th:classappend="${khuyenMaiPage.last ? 'pointer-events-none text-gray-300 bg-gray-100' : 'text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </nav>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to set filter values based on URL parameters
        function setFilterValuesFromURL() {
            const params = new URLSearchParams(window.location.search);
            document.getElementById('name').value = params.get('name') || '';
            document.getElementById('status').value = params.get('status') || '';
            document.getElementById('startDate').value = params.get('startDate') || '';
            document.getElementById('endDate').value = params.get('endDate') || '';
        }

        // Handle form submission for filtering
        document.querySelector('form[th\:action="@{/admin/khuyen-mai}"]').addEventListener('submit', function(event) {
            // event.preventDefault(); // Prevent default form submission as it is already a GET form
            const params = new URLSearchParams(new FormData(this));
            params.set('page', '0'); // Reset to first page on new filter
            params.set('size', '3'); // Ensure size is always present
            window.location.href = window.location.pathname + '?' + params.toString();
        });

        // Handle Reset button
        document.querySelector('a[th\:href="@{/admin/khuyen-mai(page=0, size=3)}"]').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default anchor behavior
            window.location.href = this.href; // Navigate to the reset URL
        });

        // Initialize filter form fields from URL on page load
        setFilterValuesFromURL();
    });
</script>
</body>
</html>