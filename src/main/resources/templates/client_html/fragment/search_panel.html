<div th:fragment="search_panel" class="max-w-5xl mx-auto p-4">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Montserrat', sans-serif; }
        .province-suggestions {
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 50;
            margin-top: 0.25rem;
            display: none;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: #f8fafc;
        }

        .suggestion-item.active {
            background-color: #eff6ff;
        }

        .province-suggestions::-webkit-scrollbar {
            width: 6px;
        }

        .province-suggestions::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .province-suggestions::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .province-suggestions::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>

    <div class="bg-white rounded-xl shadow-2xl p-6 transition-all duration-500 hover:shadow-3xl">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <!-- Destination Search with Province Suggestions -->
            <div class="relative group">
                <label class="block text-sm font-medium text-gray-700 mb-1">Điểm đến mơ ước</label>
                <div class="relative">
                    <input
                            type="text"
                            id="locationInput"
                            placeholder="Nhập tỉnh/thành phố..."
                            class="w-full py-3 pl-10 pr-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white"
                            autocomplete="off"
                    >
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <div id="provinceSuggestions" class="province-suggestions"></div>
                </div>
            </div>

            <!-- Date Picker -->
            <div class="relative group">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ngày đi</label>
                <div class="relative">
                    <input
                            type="text"
                            id="dateInput"
                            placeholder="Chọn ngày đi"
                            class="w-full py-3 pl-10 pr-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white datepicker"
                    >
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Price Range Selector -->
            <div class="relative group">
                <label class="block text-sm font-medium text-gray-700 mb-1">Mức giá</label>
                <div class="relative">
                    <select id="priceSelect" class="w-full py-3 pl-10 pr-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white appearance-none">
                        <option value="">Tất cả</option>
                        <option value="0-2000000">Dưới 2 triệu</option>
                        <option value="2000000-5000000">2 - 5 triệu</option>
                        <option value="5000000-10000000">5 - 10 triệu</option>
                        <option value="10000000-999999999">Trên 10 triệu</option>
                    </select>
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Search Button -->
            <div class="flex items-end">
                <button id="searchButton" type="button" class="w-full bg-gradient-to-r from-blue-600 to-teal-600 hover:from-blue-700 hover:to-teal-700 text-white py-3 px-6 rounded-lg font-semibold shadow-md transition-all duration-300 transform hover:scale-[1.02] flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Tìm Kiếm
                </button>
            </div>
        </div>
    </div>

    <script>
        // Danh sách tỉnh thành Việt Nam và các quốc gia
        const vietnamProvinces = [
            "Tỉnh An Giang",
            "Tỉnh Bà Rịa - Vũng Tàu",
            "Tỉnh Bắc Giang",
            "Tỉnh Bắc Kạn",
            "Tỉnh Bạc Liêu",
            "Tỉnh Bắc Ninh",
            "Tỉnh Bến Tre",
            "Tỉnh Bình Định",
            "Tỉnh Bình Dương",
            "Tỉnh Bình Phước",
            "Tỉnh Bình Thuận",
            "Tỉnh Cà Mau",
            "Thành phố Cần Thơ",
            "Tỉnh Cao Bằng",
            "Thành phố Đà Nẵng",
            "Tỉnh Đắk Lắk",
            "Tỉnh Đắk Nông",
            "Tỉnh Điện Biên",
            "Tỉnh Đồng Nai",
            "Tỉnh Đồng Tháp",
            "Tỉnh Gia Lai",
            "Tỉnh Hà Giang",
            "Tỉnh Hà Nam",
            "Thành phố Hà Nội",
            "Tỉnh Hà Tĩnh",
            "Tỉnh Hải Dương",
            "Thành phố Hải Phòng",
            "Tỉnh Hậu Giang",
            "Tỉnh Hòa Bình",
            "Tỉnh Hưng Yên",
            "Tỉnh Khánh Hòa",
            "Tỉnh Kiên Giang",
            "Tỉnh Kon Tum",
            "Tỉnh Lai Châu",
            "Tỉnh Lâm Đồng",
            "Tỉnh Lạng Sơn",
            "Tỉnh Lào Cai",
            "Tỉnh Long An",
            "Tỉnh Nam Định",
            "Tỉnh Nghệ An",
            "Tỉnh Ninh Bình",
            "Tỉnh Ninh Thuận",
            "Tỉnh Phú Thọ",
            "Tỉnh Phú Yên",
            "Tỉnh Quảng Bình",
            "Tỉnh Quảng Nam",
            "Tỉnh Quảng Ngãi",
            "Tỉnh Quảng Ninh",
            "Tỉnh Quảng Trị",
            "Tỉnh Sóc Trăng",
            "Tỉnh Sơn La",
            "Tỉnh Tây Ninh",
            "Tỉnh Thái Bình",
            "Tỉnh Thái Nguyên",
            "Tỉnh Thanh Hóa",
            "Tỉnh Thừa Thiên Huế",
            "Tỉnh Tiền Giang",
            "Thành phố Hồ Chí Minh",
            "Tỉnh Trà Vinh",
            "Tỉnh Tuyên Quang",
            "Tỉnh Vĩnh Long",
            "Tỉnh Vĩnh Phúc",
            "Tỉnh Yên Bái",
            // Các quốc gia châu Á
            "Thái Lan",
            "Singapore",
            "Trung Quốc",
            "Nhật Bản",
            "Hàn Quốc",
            "Malaysia",
            "Indonesia",
            "Philippines",
            "Ấn Độ",
            "Myanmar",
            "Campuchia",
            "Lào",
            // Các quốc gia châu Âu
            "Pháp",
            "Tây Ban Nha",
            "Thụy Sĩ",
            "Ý",
            "Hà Lan",
            "Đức",
            "Anh",
            "Thụy Điển",
            "Na Uy",
            "Bồ Đào Nha",
            "Áo",
            "Bỉ",
            // Các quốc gia châu Mỹ
            "Hoa Kỳ",
            "Canada",
            "Mexico",
            "Brazil",
            "Argentina",
            "Peru",
            "Cuba",
            "Chile",
            // Châu Úc
            "Úc",
            "New Zealand",
            "Fiji",
            // Châu Phi
            "Ai Cập",
            "Nam Phi",
            "Mauritius",
            "Kenya",
            "Madagascar"
        ];

        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo date picker
            if (typeof flatpickr !== 'undefined') {
                flatpickr("#dateInput", {
                    dateFormat: "d/m/Y",
                    minDate: "today",
                    locale: "vn",
                    static: true
                });
            }

            let activeSuggestionIndex = -1;
            const locationInput = document.getElementById('locationInput');
            const provinceSuggestions = document.getElementById('provinceSuggestions');

            if (locationInput && provinceSuggestions) {
                // Xử lý gợi ý tỉnh thành
                locationInput.addEventListener('input', showSuggestions);
                locationInput.addEventListener('focus', showSuggestions);

                // Xử lý phím mũi tên lên/xuống
                locationInput.addEventListener('keydown', function(e) {
                    const items = document.querySelectorAll('.suggestion-item');

                    if (items.length === 0) return;

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        activeSuggestionIndex = (activeSuggestionIndex + 1) % items.length;
                        scrollToItem(items, activeSuggestionIndex);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        activeSuggestionIndex = (activeSuggestionIndex - 1 + items.length) % items.length;
                        scrollToItem(items, activeSuggestionIndex);
                    } else if (e.key === 'Enter' && activeSuggestionIndex >= 0) {
                        e.preventDefault();
                        locationInput.value = items[activeSuggestionIndex].textContent;
                        provinceSuggestions.style.display = 'none';
                    }
                });

                // Ẩn dropdown khi click ra ngoài
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('#locationInput, #provinceSuggestions')) {
                        provinceSuggestions.style.display = 'none';
                    }
                });
            }

            // Xử lý tìm kiếm
            const searchButton = document.getElementById('searchButton');
            if (searchButton) {
                searchButton.addEventListener('click', function() {
                    const location = document.getElementById('locationInput')?.value.trim();
                    const priceRange = document.getElementById('priceSelect')?.value;
                    const startDate = document.getElementById('dateInput')?.value;

                    // Validate dữ liệu
                    if (!location) {
                        alert('Vui lòng nhập điểm đến');
                        return;
                    }

                    if (!priceRange) {
                        alert('Vui lòng chọn khoảng giá');
                        return;
                    }

                    if (!startDate) {
                        alert('Vui lòng chọn ngày đi');
                        return;
                    }

                    // Format lại ngày tháng từ dd/mm/yyyy sang yyyy-mm-dd
                    const formattedDate = formatDateToISO(startDate);

                    // Tạo URL với các tham số
                    const params = new URLSearchParams();
                    params.append('location', location);
                    params.append('priceRange', priceRange);
                    params.append('startDate', formattedDate);

                    const url = `/Client/ToursList?${params.toString()}`;

                    // Chuyển hướng đến trang kết quả
                    window.location.href = url;
                });
            }

            function showSuggestions() {
                const input = locationInput.value.toLowerCase();
                provinceSuggestions.innerHTML = '';
                activeSuggestionIndex = -1;

                if (!input) {
                    provinceSuggestions.style.display = 'none';
                    return;
                }

                const matchedProvinces = vietnamProvinces.filter(province =>
                    province.toLowerCase().includes(input)
                );

                if (matchedProvinces.length === 0) {
                    provinceSuggestions.style.display = 'none';
                    return;
                }

                matchedProvinces.forEach((province, index) => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.textContent = province;

                    suggestionItem.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        locationInput.value = province;
                        provinceSuggestions.style.display = 'none';
                    });

                    suggestionItem.addEventListener('mouseenter', function() {
                        document.querySelectorAll('.suggestion-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        this.classList.add('active');
                        activeSuggestionIndex = index;
                    });

                    provinceSuggestions.appendChild(suggestionItem);
                });

                provinceSuggestions.style.display = 'block';
            }

            function scrollToItem(items, index) {
                items.forEach(item => {
                    item.classList.remove('active');
                });
                items[index].classList.add('active');
                items[index].scrollIntoView({ block: 'nearest' });
            }

            // Hàm chuyển đổi định dạng ngày tháng
            function formatDateToISO(dateString) {
                if (!dateString) return '';

                const parts = dateString.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
                return dateString;
            }

            // Tự động focus vào ô tìm kiếm khi fragment được load
            if (locationInput) {
                locationInput.focus();
            }
        });
    </script>
</div>