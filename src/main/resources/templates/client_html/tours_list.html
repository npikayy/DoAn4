<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách Tour</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .tour-card {
            transition: all 0.3s ease;
        }
        .tour-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .tour-image {
            transition: transform 0.5s ease;
        }
        .tour-image:hover {
            transform: scale(1.05);
        }
        .filter-options {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .line-clamp {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .hidden-card {
            display: none;
        }

        .filter-options {
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 0;
        }

        .filter-options.active {
            max-height: 500px;
        }

        /* Animation for filter toggle */
        .filter-section {
            transition: max-height 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">
<header th:replace="client_html/fragment/headerANDfooter :: header"></header>

<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <div class="text-sm text-gray-600 mb-6">
        <a href="/Client/Home" class="hover:text-blue-800 hover:underline">Trang chủ</a>
        <span class="mx-2">/</span>
        <a href="/Client/ToursList" class="hover:text-blue-800 hover:underline">Du lịch</a>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Filter Section -->
        <div id="filterContainer" class="bg-white p-6 rounded-xl shadow-lg top-4 border border-gray-100">
            <!-- Header với icon -->
            <div class="flex items-center mb-6 pb-4 border-b border-gray-200">
                <i class="fas fa-sliders-h text-blue-600 mr-3 text-lg"></i>
                <h2 class="text-xl font-bold text-gray-800">Bộ Lọc Tour</h2>
            </div>

            <!-- Search Box với hiệu ứng focus đẹp -->
            <div class="mb-6">
                <div class="relative">
                    <input type="text" id="searchTourName" placeholder="Tìm kiếm theo tên tour..."
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 placeholder-gray-400">
                    <i class="fas fa-search absolute right-4 top-3.5 text-gray-400"></i>
                </div>
            </div>

            <!-- Các bộ lọc được thiết kế card -->
            <div class="space-y-5">
                <!-- Region Filter -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-map-marked-alt text-blue-500 mr-2"></i>
                        Khu vực
                    </h3>
                    <select id="filterRegion" class="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <option value="">Tất cả khu vực</option>
                        <option value="NORTH" class="py-1">Miền Bắc</option>
                        <option value="CENTRAL">Miền Trung</option>
                        <option value="SOUTHEAST">Miền Đông Nam Bộ</option>
                        <option value="SOUTHWEST">Miền Tây Nam Bộ</option>
                    </select>
                </div>

                <!-- Price Filter -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-tag text-blue-500 mr-2"></i>
                        Mức giá
                    </h3>
                    <select id="filterPriceRange" class="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <option value="">Tất cả mức giá</option>
                        <option value="0-2000000">Dưới 2 triệu</option>
                        <option value="2000000-5000000">2 - 5 triệu</option>
                        <option value="5000000-10000000">5 - 10 triệu</option>
                        <option value="10000000-999999999">Trên 10 triệu</option>
                    </select>
                </div>

                <!-- Tour Type Filter -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-globe-asia text-blue-500 mr-2"></i>
                        Loại tour
                    </h3>
                    <select id="filterTourType" class="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <option value="">Tất cả loại tour</option>
                        <option value="DOMESTIC">Tour trong nước</option>
                        <option value="INTERNATIONAL">Tour nước ngoài</option>
                        <option value="BUDGET">Tour tiết kiệm</option>
                        <option value="PREMIUM">Tour cao cấp</option>
                    </select>
                </div>

                <!-- Departure Status Filter -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
                        Lịch khởi hành
                    </h3>
                    <select id="filterDepartureStatus" class="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <option value="">Tất cả</option>
                        <option value="HAS_DEPARTURE">Có lịch khởi hành</option>
                        <option value="NO_DEPARTURE">Chưa có lịch</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tour List Section -->
        <div class="lg:w-3/4">
            <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <span id="tourCount" th:text="${tours.size()}"></span> tour phù hợp với yêu cầu của bạn
                </h2>
            </div>

            <!-- No Results Message (hidden by default) -->
            <div id="noResultsMessage" class="hidden bg-gray-100 p-6 rounded-lg text-center text-gray-600 mb-6">
                <i class="fas fa-exclamation-circle mr-2"></i> Không tìm thấy tour nào phù hợp với tiêu chí của bạn
            </div>
            <!-- Single Column Tour List -->
            <div class="space-y-6">
                <!-- Tour Card - Full Width -->
                <div th:each="tour : ${tours}"
                     class="tour-card bg-white rounded-xl shadow-sm overflow-hidden transition duration-300 hover:shadow-md border border-gray-100"
                     th:data-tour-id="${tour.tour_id}"
                     th:data-region="${tour.tour_region}"
                     th:data-price="${tour.tour_discount != null} ? ${tour.tour_adult_price * (100 - tour.tour_discount) / 100} : ${tour.tour_adult_price}"
                     th:data-duration="${tour.tour_duration}"
                     th:data-tour-type="${tour.tour_type}"
                     th:data-has-discount="${tour.tour_discount != null && tour.tour_discount > 0}">

                    <div class="flex flex-col md:flex-row">
                        <!-- Tour Image -->
                        <div class="md:w-1/3 h-64 relative overflow-hidden">
                            <img th:if="${tourThumbnails.get(tour.tour_id) != null and !tourThumbnails.get(tour.tour_id).isEmpty()}"
                                 th:src="${tourThumbnails.get(tour.tour_id)}"
                                 alt="Tour image"
                                 class="w-full h-full object-cover transition-transform duration-500 hover:scale-105">
                            <img th:unless="${tourThumbnails.get(tour.tour_id) != null and !tourThumbnails.get(tour.tour_id).isEmpty()}"
                                 src="/img/default-tour.jpg"
                                 alt="Default tour image"
                                 class="w-full h-full object-cover">

                            <!-- Discount Badge -->
                            <div th:if="${tour.tour_discount != null and tour.tour_discount > 0}"
                                 class="absolute top-4 right-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-bold shadow-md">
                                <span th:text="'-' + ${tour.tour_discount} + '%'"></span>
                            </div>

                            <!-- Duration Badge -->
                            <div class="absolute bottom-4 bg-white left-4 bg-white/90 text-gray-800 px-3 py-1 rounded-full text-sm font-semibold shadow-sm">
                                <i class="fas fa-clock text-blue-500 mr-1"></i>
                                <span th:text="${tour.tour_duration} + ' ngày ' + (${tour.tour_duration} - 1) + ' đêm'"></span>
                            </div>
                        </div>

                        <!-- Tour Info -->
                        <div class="md:w-2/3 p-6 flex flex-col">
                            <div class="flex-grow">
                                <!-- Tour Name -->
                                <h3 class="text-xl font-bold text-gray-800 mb-3 hover:text-blue-600 transition-colors">
                                    <a th:href="@{'/Client/TourDetail/' + ${tour.tour_id}}" th:text="${tour.tour_name}"></a>
                                </h3>
                                <!-- Rating -->
                                <div class="flex items-center mb-3">
                                    <div class="flex text-yellow-400 mr-2">
                                        <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                            <i th:class="${i <= tour.tour_rating} ? 'fas fa-star text-yellow-400' :
                                ((${(i > tour.tour_rating) and (i-1 < tour.tour_rating)}) ? 'fas fa-star-half-alt text-yellow-400' :
                                'far fa-star text-yellow-400')"></i>
                                        </th:block>
                                    </div>
                                    <span class="text-sm font-bold text-gray-600 font-medium"
                                          th:text="${#numbers.formatDecimal(tour.tour_rating, 1, 1)}"></span>
                                </div>
                                <!-- Location & Date -->
                                <div class="flex flex-wrap gap-4 text-gray-600 mb-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>
                                        <span th:text="${tour.tour_end_location}"></span>
                                    </div>
                                    <!-- Departure Dates -->
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar-day text-blue-500 mr-2"></i>
                                        <div class="flex flex-wrap gap-1.5">
                                            <!-- Hiển thị tối đa 3 ngày -->
                                            <span th:each="date,iter : ${tourStartDates.get(tour.tour_id)}"
                                                  th:if="${iter.index < 3}"
                                                  class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                        <span th:text="${#temporals.format(date.start_date, 'dd/MM')}"></span>
                    </span>
                                            <!-- Hiển thị số lượng ngày còn lại nếu có -->
                                            <span th:if="${tourStartDates.get(tour.tour_id).size() > 3}"
                                                  class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">
                        +<span th:text="${tourStartDates.get(tour.tour_id).size() - 3}"></span> ngày khác
                    </span>
                                            <!-- Trường hợp không có ngày khởi hành -->
                                            <span th:if="${tourStartDates.get(tour.tour_id).isEmpty()}"
                                                  class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">
                        Chưa có lịch
                    </span>
                                        </div>
                                    </div>
                                    <div class="flex items-center bg-blue-50/50 px-3 py-1.5 rounded-full text-sm">
    <span class="flex items-center">
        <!-- Icon phương tiện -->
        <span th:switch="${tour.tour_transportation}">
            <i th:case="'PLANE'" class="fas fa-plane text-blue-600 mr-1.5"></i>
            <i th:case="'CAR'" class="fas fa-car text-blue-600 mr-1.5"></i>
            <i th:case="'TRAIN'" class="fas fa-train text-blue-600 mr-1.5"></i>
            <i th:case="*" class="fas fa-bus text-blue-600 mr-1.5"></i>
        </span>

        <!-- Tên phương tiện -->
        <span th:switch="${tour.tour_transportation}"
              class="font-medium text-gray-700">
            <span th:case="'PLANE'">Máy bay</span>
            <span th:case="'CAR'">Ô tô riêng</span>
            <span th:case="'TRAIN'">Tàu hỏa</span>
            <span th:case="*">Xe du lịch</span>
        </span>
    </span>
                                    </div>
                                </div>

                                <!-- Short Description -->
                                <p class="text-gray-600 mb-4 line-clamp" th:text="${tour.tour_description} ?: 'Khám phá hành trình đầy thú vị'"></p>
                            </div>

                            <!-- Price & Button -->
                            <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                                <div>
                                    <div th:if="${tour.tour_discount != null && tour.tour_discount > 0}"
                                         class="text-sm text-gray-400 line-through mb-1">
                                        <span th:text="${#numbers.formatInteger(tour.tour_adult_price, 3, 'POINT') + '₫'}"></span>
                                    </div>
                                    <div class="text-blue-600 font-bold text-xl">
                <span th:text="${tour.tour_discount != null} ?
                          ${#numbers.formatInteger(tour.tour_adult_price * (100 - tour.tour_discount) / 100, 3, 'POINT') + '₫'} :
                          ${#numbers.formatInteger(tour.tour_adult_price, 3, 'POINT') + '₫'}"></span>
                                    </div>
                                </div>
                                <a th:href="@{'/Client/TourDetail/' + ${tour.tour_id}}"
                                   class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium transition flex items-center">
                                    <i class="fas fa-eye mr-2"></i> Xem chi tiết
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pagination would go here if needed -->
        </div>
    </div>
</div>

<footer th:replace="client_html/fragment/headerANDfooter :: footer"></footer>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Fuse.js for fuzzy search
        let fuse = null;
        initializeFuse();

        // Get all filter elements
        const searchInput = document.getElementById('searchTourName');
        const typeFilter = document.getElementById('filterTourType');
        const regionFilter = document.getElementById('filterRegion');
        const priceFilter = document.getElementById('filterPriceRange');
        const departureFilter = document.getElementById('filterDepartureStatus');
        const resetBtn = document.getElementById('resetFilters');
        const applyBtn = document.getElementById('applyFilters');

        // Get all tour cards
        const tourCards = document.querySelectorAll('.tour-card');
        const noResultsMessage = document.createElement('div');
        noResultsMessage.id = 'noResultsMessage';
        noResultsMessage.className = 'hidden bg-gray-100 p-6 rounded-lg text-center text-gray-600';
        noResultsMessage.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i> Không tìm thấy tour nào phù hợp với tiêu chí của bạn';
        document.querySelector('.space-y-6').prepend(noResultsMessage);

        // Add event listeners
        searchInput.addEventListener('input', filterTours);
        typeFilter.addEventListener('change', filterTours);
        regionFilter.addEventListener('change', filterTours);
        priceFilter.addEventListener('change', filterTours);
        departureFilter.addEventListener('change', filterTours);

        // Initial filter
        filterTours();
    });

    function initializeFuse() {
        const tourCards = document.querySelectorAll('.tour-card');
        const tourData = Array.from(tourCards).map(card => ({
            element: card,
            name: card.querySelector('h3 a').textContent.toLowerCase(),
            destination: card.getAttribute('data-destination'),
            region: card.getAttribute('data-region'),
            type: card.getAttribute('data-tour-type')
        }));

        const options = {
            keys: ['name', 'destination', 'region'],
            threshold: 0.4,
            includeScore: true,
            minMatchCharLength: 2
        };

        fuse = new Fuse(tourData, options);
    }

    function filterTours() {
        const searchQuery = document.getElementById('searchTourName').value.toLowerCase();
        const selectedType = document.getElementById('filterTourType').value;
        const selectedRegion = document.getElementById('filterRegion').value;
        const priceRange = document.getElementById('filterPriceRange').value;
        const departureStatus = document.getElementById('filterDepartureStatus').value;

        const tourCards = document.querySelectorAll('.tour-card');
        let visibleCount = 0;

        tourCards.forEach(card => {
            const name = card.querySelector('h3 a').textContent.toLowerCase();
            const type = card.getAttribute('data-tour-type');
            const region = card.getAttribute('data-region');
            const price = parseFloat(card.getAttribute('data-price'));
            const hasDepartureDates = card.querySelector('.bg-blue-100') !== null; // Kiểm tra có ngày khởi hành không

            // Kiểm tra các điều kiện lọc
            const matchesSearch = searchQuery === '' || name.includes(searchQuery);
            const matchesType = selectedType === '' || type === selectedType;
            const matchesRegion = selectedRegion === '' || region === selectedRegion;
            const matchesPrice = priceRange === '' || checkPriceRange(price, priceRange);
            const matchesDepartureStatus = departureStatus === '' ||
                (departureStatus === 'HAS_DEPARTURE' && hasDepartureDates) ||
                (departureStatus === 'NO_DEPARTURE' && !hasDepartureDates);

            if (matchesSearch && matchesType && matchesRegion && matchesPrice && matchesDepartureStatus) {
                card.classList.remove('hidden');
                visibleCount++;
            } else {
                card.classList.add('hidden');
            }
        });

        // Cập nhật số lượng tour phù hợp
        document.querySelector('h2.text-2xl').innerHTML =
            `<span>${visibleCount}</span> tour phù hợp với yêu cầu của bạn`;

        // Hiển thị thông báo khi không có kết quả
        toggleNoResultsMessage(visibleCount);
    }

    function checkPriceRange(price, range) {
        const [min, max] = range.split('-').map(Number);
        return price >= min && price <= max;
    }

    function toggleNoResultsMessage(visibleCount) {
        const noResultsMessage = document.getElementById('noResultsMessage');
        if (visibleCount === 0) {
            noResultsMessage.classList.remove('hidden');
        } else {
            noResultsMessage.classList.add('hidden');
        }
    }

    function resetFilters() {
        // Reset các giá trị filter
        document.getElementById('searchTourName').value = '';
        document.getElementById('filterTourType').selectedIndex = 0;
        document.getElementById('filterRegion').selectedIndex = 0;
        document.getElementById('filterPriceRange').selectedIndex = 0;
        document.getElementById('filterDepartureStatus').selectedIndex = 0;

        // Áp dụng lại filter (sẽ hiển thị tất cả tour)
        filterTours();
    }

    function checkPriceRange(price, range) {
        if (!range) return true;
        const [min, max] = range.split('-').map(Number);
        return price >= min && price <= max;
    }

    function toggleNoResultsMessage(visibleCount) {
        const noResultsMessage = document.getElementById('noResultsMessage');
        if (visibleCount === 0) {
            noResultsMessage.classList.remove('hidden');
        } else {
            noResultsMessage.classList.add('hidden');
        }
    }

    function resetFilters() {
        document.getElementById('searchTourName').value = '';
        document.getElementById('filterTourType').value = '';
        document.getElementById('filterRegion').value = '';
        document.getElementById('filterPriceRange').value = '';
        document.getElementById('filterDepartureStatus').value = '';

        // Reset all filter sections to open
        document.querySelectorAll('.filter-options').forEach(options => {
            options.classList.add('active');
        });

        // Reset all chevrons to down
        document.querySelectorAll('.flex.justify-between i').forEach(icon => {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        });

        filterTours();
    }
</script>
</body>
</html>