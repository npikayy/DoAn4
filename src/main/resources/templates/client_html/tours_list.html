<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách Tour</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
<!--    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .tour-card {
            transition: all 0.3s ease;
        }
        .tour-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .tour-image {
            transition: transform 0.5s ease;
        }
        .tour-image:hover {
            transform: scale(1.05);
        }
        .filter-options {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .line-clamp {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .hidden-card {
            display: none;
        }

        .filter-options {
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 0;
        }

        .filter-options.active {
            max-height: 500px;
        }

        /* Animation for filter toggle */
        .filter-section {
            transition: max-height 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">
<header th:replace="client_html/fragment/headerANDfooter :: header"></header>

<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <div class="text-sm text-gray-600 mb-6">
        <a href="/Client/Home" class="hover:text-blue-800 hover:underline">Trang chủ</a>
        <span class="mx-2">/</span>
        <a href="/Client/ToursList" class="hover:text-blue-800 hover:underline">Du lịch</a>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Filter Section -->
        <div id="filterContainer" class="bg-white p-6 rounded-xl shadow-lg top-4 border border-gray-100 lg:w-1/4">
            <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-sliders-h text-blue-600 mr-3 text-lg"></i>
                    <h2 class="text-xl font-bold text-gray-800">Bộ Lọc Tour</h2>
                </div>
            </div>

            <div class="space-y-5">
                <!-- Search Box -->
                <div>
                    <label for="searchTourName" class="font-semibold text-gray-700 mb-2 block">Tên tour</label>
                    <div class="relative">
                        <input type="text" id="searchTourName" placeholder="Nhập tên tour..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                    </div>
                </div>



                <!-- Tour Type (Trong nước/Nước ngoài) -->
                <div>
                    <label for="filterIsAbroad" class="font-semibold text-gray-700 mb-2 block">Phân loại</label>
                    <select id="filterIsAbroad" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <option value="">Tất cả</option>
                        <option value="false">Tour trong nước</option>
                        <option value="true">Tour nước ngoài</option>
                    </select>
                </div>

                <!-- Region -->
                <div>
                    <label for="filterRegion" class="font-semibold text-gray-700 mb-2 block">Khu vực</label>
                    <select id="filterRegion" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <option value="">Tất cả khu vực</option>
                        <option value="NORTH">Miền Bắc</option>
                        <option value="CENTRAL">Miền Trung</option>
                        <option value="SOUTHEAST">Miền Đông Nam Bộ</option>
                        <option value="SOUTHWEST">Miền Tây Nam Bộ</option>
                        <option value="INTERNATIONAL">Quốc tế</option>
                    </select>
                </div>

                <!-- Duration -->
                <div>
                    <label for="filterDuration" class="font-semibold text-gray-700 mb-2 block">Thời lượng</label>
                    <select id="filterDuration" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <option value="">Tất cả</option>
                        <option value="1-3">1-3 ngày</option>
                        <option value="4-7">4-7 ngày</option>
                        <option value="8-14">8-14 ngày</option>
                        <option value="15-999">Trên 14 ngày</option>
                    </select>
                </div>

                <!-- Transportation -->
                <div>
                    <label for="filterTransportation" class="font-semibold text-gray-700 mb-2 block">Phương tiện</label>
                    <select id="filterTransportation" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <option value="">Tất cả</option>
                        <option value="PLANE">Máy bay</option>
                        <option value="CAR">Xe ô tô</option>
                        <option value="TRAIN">Tàu hỏa</option>
                        <option value="BUS">Xe khách</option>
                    </select>
                </div>
                
                <!-- Location -->
                <div>
                    <label for="filterLocation" class="font-semibold text-gray-700 mb-2 block">Địa điểm</label>
                    <select id="filterLocation" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <option value="">Tất cả</option>
                        <option th:each="loc : ${uniqueLocations}" th:value="${loc}" th:text="${loc}"></option>
                    </select>
                </div>

                <!-- Promotion -->
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="filterHasPromotion" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-2 text-gray-700">Đang có khuyến mãi hoặc khuyến mãi sắp bắt đầu</span>
                    </label>
                </div>

                <!-- Start Date -->
                <div>
                    <label for="filterStartDate" class="font-semibold text-gray-700 mb-2 block">Ngày khởi hành</label>
                    <input type="date" id="filterStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                </div>

                <!-- Rating -->
                <div>
                    <label for="filterRating" class="font-semibold text-gray-700 mb-2 block">Đánh giá</label>
                    <select id="filterRating" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <option value="">Tất cả</option>
                        <option value="5">5 sao</option>
                        <option value="4">4 sao trở lên</option>
                        <option value="3">3 sao trở lên</option>
                    </select>
                </div>

                <!-- Price Filter -->
                <div>
                    <label for="filterPriceRange" class="font-semibold text-gray-700 mb-2 block">Mức giá</label>
                    <select id="filterPriceRange" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition">
                        <option value="">Tất cả</option>
                        <option value="0-2000000">Dưới 2 triệu</option>
                        <option value="2000000-5000000">2 - 5 triệu</option>
                        <option value="5000000-10000000">5 - 10 triệu</option>
                        <option value="10000000-999999999">Trên 10 triệu</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 pt-6 border-t border-gray-200 space-y-3">
                <button id="applyFilters" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all">Áp dụng bộ lọc</button>
                <button id="resetFilters" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 rounded-lg transition-all">Xóa bộ lọc</button>
            </div>
        </div>

        <!-- Tour List Section -->
        <div class="lg:w-3/4">
            <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <span id="tourCount" th:text="${tourPage.totalElements}"></span> tour phù hợp với yêu cầu của bạn
                </h2>
            </div>

            <!-- No Results Message (hidden by default) -->
            <div id="noResultsMessage" th:if="${tourPage.empty}" class="bg-gray-100 p-6 rounded-lg text-center text-gray-600 mb-6">
                <i class="fas fa-exclamation-circle mr-2"></i> Không tìm thấy tour nào phù hợp với tiêu chí của bạn
            </div>
            <!-- Single Column Tour List -->
            <div class="space-y-6" th:unless="${tourPage.empty}">
                <!-- Tour Card - Full Width -->
                <div th:each="tour : ${tourPage.content}"
                     th:with="promotion=${tour.getDiscount_promotion()},
                              isPromotionActive=${promotion != null and #dates.createNow().after(promotion.ngayBatDau) and #dates.createNow().before(promotion.ngayKetThuc)},
                              isPromotionUpcoming=${promotion != null and #dates.createNow().before(promotion.ngayBatDau)}"
                     class="tour-card bg-white rounded-xl shadow-sm overflow-hidden transition duration-300 hover:shadow-md border border-gray-100"
                     th:data-tour-id="${tour.tour_id}"
                     th:data-region="${tour.tour_region}"
                     th:data-price="${isPromotionActive} ? ${tour.tour_adult_price * (100 - promotion.phanTramGiamGia) / 100} : ${tour.tour_adult_price}"
                     th:data-duration="${tour.tour_duration}"
                     th:data-tour-type="${tour.tour_type}"
                     th:data-has-discount="${isPromotionActive}">

                    <div class="flex flex-col md:flex-row">
                        <!-- Tour Image -->
                        <div class="md:w-1/3 h-64 relative overflow-hidden">
                            <img th:if="${tourThumbnails.get(tour.tour_id) != null and !tourThumbnails.get(tour.tour_id).isEmpty()}"
                                 th:src="${tourThumbnails.get(tour.tour_id)}"
                                 alt="Tour image"
                                 class="w-full h-full object-cover transition-transform duration-500 hover:scale-105">
                            <img th:unless="${tourThumbnails.get(tour.tour_id) != null and !tourThumbnails.get(tour.tour_id).isEmpty()}"
                                 src="/img/default-tour.jpg"
                                 alt="Default tour image"
                                 class="w-full h-full object-cover">

                            <!-- Active Discount Badge -->
                            <div th:if="${isPromotionActive}"
                                 class="absolute top-4 right-4">
                                <span class="bg-red-500 text-white px-3 py-1 text-sm font-bold shadow-md rounded-full" th:text="${promotion.getTenKhuyenMai()}"></span>
                                <span class="bg-red-500 text-white px-3 py-1 text-sm font-bold shadow-md rounded-full " th:text="'- ' + ${promotion.getPhanTramGiamGia()} + '%'"></span>
                            </div>

                            <!-- Upcoming Promotion Badge -->
                            <div th:if="${isPromotionUpcoming}"
                                 class="absolute top-4 left-4 bg-green-500 text-white px-3 py-1 text-sm font-semibold shadow-md rounded-full">
                                <i class="fas fa-bell mr-1"></i>
                                Khuyến mãi sẽ bắt đầu vào: <span th:text="${#dates.format(promotion.ngayBatDau, 'dd/MM/yyyy')}"></span>
                            </div>

                            <!-- Duration Badge -->
                            <div class="absolute bottom-4 bg-white left-4 bg-white/90 text-gray-800 px-3 py-1 text-sm font-semibold shadow-sm">
                                <i class="fas fa-clock text-blue-500 mr-1"></i>
                                <span th:text="${tour.tour_duration} + ' ngày ' + (${tour.tour_duration} - 1) + ' đêm'"></span>
                            </div>
                        </div>

                        <!-- Tour Info -->
                        <div class="md:w-2/3 p-6 flex flex-col">
                            <div class="flex-grow">
                                <!-- Tour Name -->
                                <h3 class="text-xl font-bold text-gray-800 mb-3 hover:text-blue-600 transition-colors">
                                    <a th:href="@{'/Client/TourDetail/' + ${tour.tour_id}}" th:text="${tour.tour_name}"></a>
                                </h3>
                                <!-- Rating -->
                                <div class="flex items-center mb-3">
                                    <div class="flex text-yellow-400 mr-2">
                                        <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                            <i th:class="${i <= tour.tour_rating} ? 'fas fa-star text-yellow-400' :
                                ((${(i > tour.tour_rating) and (i-1 < tour.tour_rating)}) ? 'fas fa-star-half-alt text-yellow-400' :
                                'far fa-star text-yellow-400')"></i>
                                        </th:block>
                                    </div>
                                    <span class="text-sm font-bold text-gray-600 font-medium"
                                          th:text="${#numbers.formatDecimal(tour.tour_rating, 1, 1)}"></span>
                                </div>
                                <!-- Location & Date -->
                                <div class="flex flex-wrap gap-4 text-gray-600 mb-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>
                                        <span th:text="${tour.tour_end_location}"></span>
                                    </div>
                                    <!-- Departure Dates -->
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar-day text-blue-500 mr-2"></i>
                                        <div class="flex flex-wrap gap-1.5">
                                            <!-- Hiển thị tối đa 3 ngày -->
                                            <span th:each="date,iter : ${tourStartDates.get(tour.tour_id)}"
                                                  th:if="${iter.index < 3}"
                                                  class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                        <span th:text="${#temporals.format(date.start_date, 'dd/MM')}"></span>
                    </span>
                                            <!-- Hiển thị số lượng ngày còn lại nếu có -->
                                            <span th:if="${tourStartDates.get(tour.tour_id).size() > 3}"
                                                  class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">
                        +<span th:text="${tourStartDates.get(tour.tour_id).size() - 3}"></span> ngày khác
                    </span>
                                            <!-- Trường hợp không có ngày khởi hành -->
                                            <span th:if="${tourStartDates.get(tour.tour_id).isEmpty()}"
                                                  class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">
                        Chưa có lịch
                    </span>
                                        </div>
                                    </div>
                                    <div class="flex items-center bg-blue-50/50 px-3 py-1.5 rounded-full text-sm">
    <span class="flex items-center">
        <!-- Icon phương tiện -->
        <span th:switch="${tour.tour_transportation}">
            <i th:case="'PLANE'" class="fas fa-plane text-blue-600 mr-1.5"></i>
            <i th:case="'CAR'" class="fas fa-car text-blue-600 mr-1.5"></i>
            <i th:case="'TRAIN'" class="fas fa-train text-blue-600 mr-1.5"></i>
            <i th:case="*" class="fas fa-bus text-blue-600 mr-1.5"></i>
        </span>

        <!-- Tên phương tiện -->
        <span th:switch="${tour.tour_transportation}"
              class="font-medium text-gray-700">
            <span th:case="'PLANE'">Máy bay</span>
            <span th:case="'CAR'">Ô tô riêng</span>
            <span th:case="'TRAIN'">Tàu hỏa</span>
            <span th:case="*">Xe du lịch</span>
        </span>
    </span>
                                    </div>
                                </div>

                                <!-- Short Description -->
                                <p class="text-gray-600 mb-4 line-clamp" th:text="${tour.tour_description} ?: 'Khám phá hành trình đầy thú vị'"></p>
                            </div>

                            <!-- Price & Button -->
                            <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                                <div>
                                    <!-- If promotion is active -->
                                    <div th:if="${isPromotionActive}">
                                        <div class="text-sm text-gray-400 line-through mb-1">
                                            <span th:text="${#numbers.formatInteger(tour.tour_adult_price, 3, 'POINT') + '₫'}"></span>
                                        </div>
                                        <div class="text-blue-600 font-bold text-xl">
                                            <span th:with="discountedPrice=${tour.tour_adult_price * (100 - promotion.phanTramGiamGia) / 100}"
                                                  th:text="${#numbers.formatInteger(discountedPrice, 3, 'POINT') + '₫'}"></span>
                                        </div>
                                    </div>
                                    <!-- If no promotion or promotion is not active -->
                                    <div th:unless="${isPromotionActive}">
                                        <div class="text-blue-600 font-bold text-xl">
                                            <span th:text="${#numbers.formatInteger(tour.tour_adult_price, 3, 'POINT') + '₫'}"></span>
                                        </div>
                                    </div>
                                </div>
                                <a th:href="@{'/Client/TourDetail/' + ${tour.tour_id}}"
                                   class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium transition flex items-center">
                                    <i class="fas fa-eye mr-2"></i> Xem chi tiết
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div th:if="${tourPage.totalPages > 1}" class="flex justify-center mt-8">
                <nav class="inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <a th:href="@{/Client/ToursList(page=${currentPage - 1}, size=${tourPage.size}, keyword=${keyword}, isAbroad=${isAbroad}, duration=${duration}, transportation=${transportation}, priceRange=${priceRange}, location=${location}, region=${region}, hasPromotion=${hasPromotion}, startDate=${startDate}, rating=${rating})}"
                       th:classappend="${tourPage.first ? 'pointer-events-none text-gray-300 bg-gray-100' : 'text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <a th:each="i : ${#numbers.sequence(0, tourPage.totalPages - 1)}"
                       th:href="@{/Client/ToursList(page=${i}, size=${tourPage.size}, keyword=${keyword}, isAbroad=${isAbroad}, duration=${duration}, transportation=${transportation}, priceRange=${priceRange}, location=${location}, region=${region}, hasPromotion=${hasPromotion}, startDate=${startDate}, rating=${rating})}"
                       th:classappend="${i == currentPage ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-4 py-2 border text-sm font-medium"
                       th:text="${i + 1}">
                    </a>
                    <a th:href="@{/Client/ToursList(page=${currentPage + 1}, size=${tourPage.size}, keyword=${keyword}, isAbroad=${isAbroad}, duration=${duration}, transportation=${transportation}, priceRange=${priceRange}, location=${location}, region=${region}, hasPromotion=${hasPromotion}, startDate=${startDate}, rating=${rating})}"
                       th:classappend="${tourPage.last ? 'pointer-events-none text-gray-300 bg-gray-100' : 'text-gray-500 hover:bg-gray-50'}"
                       class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </nav>
            </div>
        </div>
    </div>
</div>

<footer th:replace="client_html/fragment/headerANDfooter :: footer"></footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to set filter values based on URL parameters
        function setFiltersFromURL() {
            const params = new URLSearchParams(window.location.search);
            document.getElementById('searchTourName').value = params.get('keyword') || '';
            document.getElementById('filterIsAbroad').value = params.get('isAbroad') || '';
            document.getElementById('filterRegion').value = params.get('region') || '';
            document.getElementById('filterDuration').value = params.get('duration') || '';
            document.getElementById('filterTransportation').value = params.get('transportation') || '';
            document.getElementById('filterPriceRange').value = params.get('priceRange') || '';
            document.getElementById('filterRating').value = params.get('rating') || '';
            document.getElementById('filterLocation').value = params.get('location') || '';
            document.getElementById('filterHasPromotion').checked = params.get('hasPromotion') === 'true';
            document.getElementById('filterStartDate').value = params.get('startDate') || '';
        }

        // Apply filters when the button is clicked
        document.getElementById('applyFilters').addEventListener('click', function() {
            const params = new URLSearchParams();
            
            const keyword = document.getElementById('searchTourName').value;
            if (keyword) params.append('keyword', keyword);

            const isAbroad = document.getElementById('filterIsAbroad').value;
            if (isAbroad) params.append('isAbroad', isAbroad);

            const region = document.getElementById('filterRegion').value;
            if (region) params.append('region', region);

            const duration = document.getElementById('filterDuration').value;
            if (duration) params.append('duration', duration);

            const transportation = document.getElementById('filterTransportation').value;
            if (transportation) params.append('transportation', transportation);

            const priceRange = document.getElementById('filterPriceRange').value;
            if (priceRange) params.append('priceRange', priceRange);

            const rating = document.getElementById('filterRating').value;
            if (rating) params.append('rating', rating);

            const location = document.getElementById('filterLocation').value;
            if (location) params.append('location', location);

            const hasPromotion = document.getElementById('filterHasPromotion').checked;
            if (hasPromotion) params.append('hasPromotion', hasPromotion);

            const startDate = document.getElementById('filterStartDate').value;
            if (startDate) params.append('startDate', startDate);

            // Always reset page to 0 and ensure size is present when applying new filters
            params.append('page', '0'); 
            params.append('size', '8'); 

            window.location.href = window.location.pathname + '?' + params.toString();
        });

        // Reset filters
        document.getElementById('resetFilters').addEventListener('click', function() {
            // Reset filters and navigate to the first page with default size
            window.location.href = window.location.pathname + '?page=0&size=8';
        });

        // Set initial state on page load
        setFiltersFromURL();

        // Set min date for start date filter
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filterStartDate').setAttribute('min', today);
    });
</script></body>
</html>