<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đơn Đặt Tour | TOD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Montserrat', sans-serif; }
        .order-status {
            min-width: 100px;
            text-align: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-paid {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-cash {
            background-color: #e0f2fe;
            color: #0369a1;
        }
        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-completed {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .filter-tab {
            transition: all 0.3s ease;
            min-width: fit-content;
        }

        .filter-tab.active {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .booking-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-50">
<!-- Header -->
<header th:replace="client_html/fragment/headerANDfooter :: header"></header>

<!-- Main Content -->
<main class="bg-gradient-to-b from-gray-50 to-gray-100 py-8 md:py-12">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <!-- Breadcrumb -->
            <div class="text-sm bg-gray-100 text-gray-800 rounded-full px-4 py-2 mb-4 inline-flex items-center font-medium">
                <a href="/Client/Home" class="hover:text-blue-600 hover:underline">Trang chủ</a>
                <span class="mx-2">/</span>
                <a href="/Client/Information" class="text-blue-600 hover:underline">Thông tin cá nhân</a>
                <span class="mx-2">/</span>
                <span class="text-blue-600 font-medium">Đơn đặt tour</span>
            </div>

            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Profile Card -->
                <div class="w-full lg:w-1/3">
                    <div class="bg-white rounded-xl shadow-sm p-6 h-full">
                        <div class="text-center mb-6">
                            <div class="w-32 h-32 rounded-full bg-gradient-to-br from-blue-600 to-teal-500 flex items-center justify-center text-white text-4xl font-bold mx-auto mb-4"
                                 th:text="${#strings.substring(user.username, 0, 1).toUpperCase()}">
                            </div>
                            <h2 class="text-xl font-semibold text-gray-800" th:text="${user.full_name}"></h2>
                            <p class="text-gray-600 text-sm" th:text="${user.email}"></p>
                            <div class="mt-3">
                                <span class="inline-block px-3 py-1 rounded-full text-xs font-medium"
                                      th:classappend="${user.getGender() == 'MALE'} ? 'bg-blue-100 text-blue-800' :
                                      (${user.getGender() == 'Nữ'} ? 'bg-pink-100 text-pink-800' : 'bg-gray-100 text-gray-800')">
                                    <i class="fas mr-1"
                                       th:classappend="${user.getGender() == 'MALE'} ? 'fa-mars' :
                                       (${user.getGender() == 'Nam'} ? 'fa-venus' : 'fa-genderless')">
                                    </i>
                                    <span th:text="${user.getGender() == 'Nam'} ? 'Nam' :
                                          (${user.getGender() == 'Nữ'} ? 'Nữ' : 'Chưa cập nhật')">
                                    </span>
                                </span>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- Phone -->
                            <div class="p-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 mr-3">
                                        <i class="fas fa-phone"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500">Điện thoại</p>
                                        <p class="font-medium" th:text="${user.phone_number} ?: 'Chưa cập nhật'"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Email -->
                            <div class="p-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 mr-3">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500">Email</p>
                                        <p class="font-medium" th:text="${user.email} ?: 'Chưa cập nhật'"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Date of Birth -->
                            <div class="p-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 mr-3">
                                        <i class="fas fa-birthday-cake"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500">Ngày sinh</p>
                                        <p class="font-medium" th:text="${user.date_of_birth} ? ${#temporals.format(user.date_of_birth, 'dd/MM/yyyy')} : 'Chưa cập nhật'"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div class="w-full lg:w-2/3">
                    <div class="bg-gradient-to-br from-white to-indigo-50 rounded-xl shadow-lg p-6 md:p-8">
                        <!-- Header with gradient background -->
                        <div class="bg-gradient-to-br from-blue-600 to-teal-500 rounded-lg p-4 mb-6 text-white">
                            <h2 class="text-2xl font-bold flex items-center">
                                Đơn đặt tour của tôi
                            </h2>
                        </div>

                        <!-- Filter and Search Section -->
                        <div class="mb-8">
                            <form th:action="@{/Client/Orders}" method="get" class="flex flex-col md:flex-row gap-4">
                                <input type="hidden" name="status" th:value="${status}">
                                <div class="relative flex-grow">
                                    <input type="text" name="searchQuery" th:value="${searchQuery}" placeholder="Tìm theo tên tour, mã đơn..."
                                           class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-search text-gray-400"></i>
                                    </div>
                                </div>
                                <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium flex items-center justify-center">
                                    <i class="fas fa-filter mr-2"></i> Lọc
                                </button>
                            </form>
                        </div>
                        
                        <!-- Status Tabs -->
                        <div class="mb-8">
                            <div class="flex space-x-2 overflow-x-auto pb-2">
                                <a th:href="@{/Client/Orders(status='all', searchQuery=${searchQuery})}"
                                   th:classappend="${status == 'all' ? 'active bg-indigo-600 text-white' : 'bg-white hover:bg-gray-100 text-gray-700'}"
                                   class="filter-tab px-4 py-2 rounded-full font-medium text-sm shadow-sm">
                                    <i class="fas fa-list mr-1"></i> Tất cả
                                </a>
                                <a th:href="@{/Client/Orders(status='Pending payment', searchQuery=${searchQuery})}"
                                   th:classappend="${status == 'Pending payment' ? 'active bg-amber-500 text-white' : 'bg-amber-100 text-amber-800 hover:bg-amber-200'}"
                                   class="filter-tab px-4 py-2 rounded-full font-medium text-sm">
                                    <i class="fas fa-clock mr-1"></i> Chờ thanh toán
                                </a>
                                <a th:href="@{/Client/Orders(status='Paid', searchQuery=${searchQuery})}"
                                   th:classappend="${status == 'Paid' ? 'active bg-green-500 text-white' : 'bg-green-100 text-green-800 hover:bg-green-200'}"
                                   class="filter-tab px-4 py-2 rounded-full font-medium text-sm">
                                    <i class="fas fa-check-circle mr-1"></i> Đã thanh toán
                                </a>
                                <a th:href="@{/Client/Orders(status='Cash', searchQuery=${searchQuery})}"
                                   th:classappend="${status == 'Cash' ? 'active bg-blue-500 text-white' : 'bg-blue-100 text-blue-800 hover:bg-blue-200'}"
                                   class="filter-tab px-4 py-2 rounded-full font-medium text-sm">
                                    <i class="fas fa-money-bill-wave mr-1"></i> Tiền mặt
                                </a>
                                <a th:href="@{/Client/Orders(status='Completed', searchQuery=${searchQuery})}"
                                   th:classappend="${status == 'Completed' ? 'active bg-purple-500 text-white' : 'bg-purple-100 text-purple-800 hover:bg-purple-200'}"
                                   class="filter-tab px-4 py-2 rounded-full font-medium text-sm">
                                    <i class="fas fa-check-double mr-1"></i> Hoàn thành
                                </a>
                                <a th:href="@{/Client/Orders(status='Cancelled', searchQuery=${searchQuery})}"
                                   th:classappend="${status == 'Cancelled' ? 'active bg-red-500 text-white' : 'bg-red-100 text-red-800 hover:bg-red-200'}"
                                   class="filter-tab px-4 py-2 rounded-full font-medium text-sm">
                                    <i class="fas fa-times-circle mr-1"></i> Đã hủy
                                </a>
                            </div>
                        </div>

                        <!-- Bookings List -->
                        <div class="grid gap-5">
                            <!-- Booking Cards -->
                            <div th:each="booking : ${bookingPage.content}" class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden hover:shadow-lg transition-all duration-300">
                                <!-- Status ribbon -->
                                <div th:classappend="${(booking.status == 'Pending payment') ? 'bg-amber-500' :
  (booking.status == 'Paid') ? 'bg-green-500' :
  (booking.status == 'Cash') ? 'bg-blue-500' :
  (booking.status == 'Cancelled') ? 'bg-red-500' :
  (booking.status == 'Completed') ? 'bg-purple-500' : 'bg-gray-500'}"
                                     class="h-1 w-full"></div>

                                <div class="p-5">
                                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                        <div class="flex-1">
                                            <div class="flex items-start justify-between">
                                                <h3 class="text-xl font-bold text-gray-800" th:text="${booking.tour_name}"></h3>
                                                <span th:classappend="${(booking.status == 'Pending payment') ? 'bg-amber-100 text-amber-800' :
  (booking.status == 'Paid') ? 'bg-green-100 text-green-800' :
  (booking.status == 'Cash') ? 'bg-blue-100 text-blue-800' :
  (booking.status == 'Cancelled') ? 'bg-red-100 text-red-800' :
  (booking.status == 'Completed') ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}"
                                                      class="px-3 py-1 rounded-full text-xs font-semibold">
<span th:text="${(booking.status == 'Pending payment') ? 'Chờ thanh toán' :
      (booking.status == 'Paid') ? 'Đã thanh toán' :
      (booking.status == 'Cash') ? 'Tiền mặt' :
      (booking.status == 'Cancelled') ? 'Đã hủy' :
      (booking.status == 'Completed') ? 'Hoàn thành' : 'Hoàn thành'}"></span>
</span>
                                            </div>

                                            <div class="mt-3 flex items-center text-sm text-gray-500">
                                                <i class="fas fa-hashtag text-indigo-500 mr-1"></i>
                                                <span th:text="'Mã đơn: ' + ${booking.booking_id}"></span>
                                            </div>

                                            <!-- Tour details section -->
                                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div class="bg-gray-50 p-3 rounded-lg">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-calendar-plus text-indigo-500 mr-2"></i>
                                                        <div>
                                                            <p class="text-xs text-gray-500">Ngày đặt</p>
                                                            <p class="font-medium" th:text="${#temporals.format(booking.booking_date, 'dd/MM/yyyy HH:mm')}"></p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="bg-gray-50 p-3 rounded-lg">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-plane-departure text-indigo-500 mr-2"></i>
                                                        <div>
                                                            <p class="text-xs text-gray-500">Ngày đi</p>
                                                            <p class="font-medium" th:text="${#temporals.format(booking.start_date, 'dd/MM/yyyy')}"></p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="bg-gray-50 p-3 rounded-lg">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-users text-indigo-500 mr-2"></i>
                                                        <div>
                                                            <p class="text-xs text-gray-500">Số lượng</p>
                                                            <p class="font-medium">
                                                                <span th:text="${booking.number_of_adults} + ' Người lớn'"></span>
                                                                <span th:if="${booking.number_of_children > 0}" th:text="', ' + ${booking.number_of_children} + ' Trẻ em'"></span>
                                                                <span th:if="${booking.number_of_infants > 0}" th:text="', ' + ${booking.number_of_infants} + ' Em bé'"></span>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="bg-gray-50 p-3 rounded-lg">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-plane-arrival text-indigo-500 mr-2"></i>
                                                        <div>
                                                            <p class="text-xs text-gray-500">Ngày về</p>
                                                            <p class="font-medium" th:text="${#temporals.format(booking.end_date, 'dd/MM/yyyy')}"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Price and action buttons -->
                                        <div class="flex flex-col items-end">
                                            <div class="text-right">
                                                <p class="text-sm text-gray-500">Tổng cộng</p>
                                                <p class="text-2xl font-bold text-indigo-600" th:text="${#numbers.formatInteger(booking.total_price, 3, 'POINT') + '₫'}"></p>
                                            </div>

                                            <div class="mt-4 flex flex-col sm:flex-row gap-2">
                                                <a th:href="'/Client/booking_search/'+ ${booking.getBooking_id()}"
                                                   class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center">
                                                    <i class="fas fa-info-circle mr-2"></i> Chi tiết
                                                </a>

                                                <a th:if="${booking.status == 'Pending payment'}"
                                                   th:href="'/Client/orderBooking/Payment/'+ ${booking.getBooking_id()}"
                                                   class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 transition-colors flex items-center justify-center">
                                                    <i class="fas fa-credit-card mr-2"></i> Thanh toán
                                                </a>
                                                <a th:if="${booking.status == 'Paid' and #temporals.createNow().toLocalDate().isAfter(booking.end_date)}"
                                                   href="#"
                                                   class="complete-tour-btn px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-lg hover:from-emerald-600 hover:to-teal-700 transition-colors flex items-center justify-center"
                                                   th:data-booking-id="${booking.booking_id}"
                                                   th:data-tour-id="${booking.tour.tour_id}"
                                                   th:data-tour-name="${booking.tour_name}">
                                                    <i class="fas fa-check-circle mr-2"></i> Hoàn thành
                                                </a>
                                                <a th:if="${booking.status == 'Pending payment'}"
                                                   href="#"
                                                   th:data-booking-id="${booking.booking_id}"
                                                   onclick="cancelBooking(event, this.getAttribute('data-booking-id'))"
                                                   class="px-4 py-2 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg hover:from-red-600 hover:to-rose-700 transition-colors flex items-center justify-center">
                                                    <i class="fas fa-times mr-2"></i> Hủy
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div th:if="${bookingPage.empty}" class="bg-gradient-to-br from-gray-50 to-indigo-50 border-2 border-dashed border-indigo-200 rounded-xl p-8 text-center">
                                <div class="inline-block bg-indigo-100 p-4 rounded-full mb-4">
                                    <i class="fas fa-suitcase text-indigo-600 text-4xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-700 mb-2">Bạn chưa có đơn đặt tour nào</h3>
                                <p class="text-gray-500 mb-6 max-w-md mx-auto">Khám phá những điểm đến tuyệt vời và tạo nên những kỷ niệm đáng nhớ với chuyến đi của bạn</p>
                                <a href="/Client/ToursList" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-colors shadow-md">
                                    <i class="fas fa-search mr-2"></i> Khám phá tour ngay
                                </a>
                            </div>
                        </div>

                        <!-- Pagination -->
                        <div th:if="${bookingPage.totalPages > 1}" class="flex justify-center mt-8">
                             <nav class="inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <a th:href="@{/Client/Orders(page=${currentPage - 1}, status=${status}, searchQuery=${searchQuery})}"
                                   th:classappend="${bookingPage.first ? 'pointer-events-none text-gray-300' : 'text-gray-500 hover:bg-gray-50'}"
                                   class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                                <a th:each="i : ${#numbers.sequence(0, bookingPage.totalPages - 1)}"
                                   th:href="@{/Client/Orders(page=${i}, status=${status}, searchQuery=${searchQuery})}"
                                   th:classappend="${i == currentPage ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}"
                                   class="relative inline-flex items-center px-4 py-2 border text-sm font-medium"
                                   th:text="${i + 1}">
                                </a>
                                 <a th:href="@{/Client/Orders(page=${currentPage + 1}, status=${status}, searchQuery=${searchQuery})}"
                                   th:classappend="${bookingPage.last ? 'pointer-events-none text-gray-300' : 'text-gray-500 hover:bg-gray-50'}"
                                   class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<footer th:replace="client_html/fragment/headerANDfooter :: footer"></footer>

<!-- Cancel Booking Modal -->
<div id="cancelModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Hủy đơn đặt tour</h3>
            <button onclick="document.getElementById('cancelModal').classList.add('hidden')"
                    class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Lý do hủy</label>
            <textarea id="cancelReason" rows="3"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            <input type="hidden" id="bookingIdToCancel">
        </div>

        <div class="flex justify-end space-x-3">
            <button type="button"
                    onclick="document.getElementById('cancelModal').classList.add('hidden')"
                    class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">
                Quay lại
            </button>
            <button id="cancelBookingButton" onclick="confirmCancelBooking()"
                    class="px-4 py-2 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg hover:from-red-600 hover:to-rose-700 transition-colors flex items-center justify-center">
    <span id="cancelSpinner" class="hidden mr-2">
        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </span>
                <i class="fas fa-times mr-2"></i> Hủy
            </button>
        </div>
    </div>
</div>
<!-- Modal Đánh Giá -->
<div id="ratingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-md mx-4">
        <!-- Header -->
        <div class="flex justify-between items-center border-b p-4">
            <h3 class="text-xl font-bold text-gray-800">Đánh giá chuyến đi</h3>
            <button id="closeRatingModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Body -->
        <div class="p-6">
            <input type="hidden" id="ratingUserId" th:value="${user_id}">
            <input type="hidden" id="ratingBookingId">
            <input type="hidden" id="ratingTourId">

            <!-- Tên tour -->
            <div class="mb-4 text-center font-medium text-lg" id="tourNameDisplay"></div>

            <!-- Điểm đánh giá -->
            <div class="mb-6 text-center">
                <p class="text-sm text-gray-600 mb-3">Bạn hài lòng thế nào với chuyến đi?</p>
                <div class="flex justify-center space-x-2" id="starRating">
                    <!-- 5 sao sẽ được tạo bằng JavaScript -->
                </div>
                <p class.="text-sm text-gray-500 mt-2" id="ratingText"></p>
            </div>

            <!-- Nhận xét -->
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Nhận xét của bạn</label>
                <textarea id="comment" rows="4"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Hãy chia sẻ trải nghiệm của bạn..."></textarea>
            </div>

            <!-- Nút gửi -->
            <button id="submitRatingBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                Gửi đánh giá
            </button>
        </div>
    </div>
</div>
<script>
    // Cancel booking function
    function cancelBooking(event, bookingId) {
        event.preventDefault();
        document.getElementById('bookingIdToCancel').value = bookingId;
        document.getElementById('cancelModal').classList.remove('hidden');
    }

    // Confirm cancel booking
    function confirmCancelBooking() {
        // Lấy các phần tử DOM cần thiết
        const bookingId = document.getElementById('bookingIdToCancel').value;
        const cancelReason = document.getElementById('cancelReason').value;
        const cancelButton = document.getElementById('cancelBookingButton');
        const spinner = document.getElementById('cancelSpinner');

        // Kiểm tra lý do hủy
        if (!cancelReason) {
            alert('Vui lòng nhập lý do hủy tour');
            return;
        }

        // Vô hiệu hóa nút và hiển thị loading
        cancelButton.disabled = true;
        spinner.classList.remove('hidden');
        cancelButton.classList.add('opacity-75');

        // Gửi yêu cầu hủy tour
        fetch('/Client/orderBooking/cancelBooking/' + bookingId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: cancelReason 
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Đã hủy đơn hàng thành công');
                    window.location.reload();
                } else {
                    throw new Error(data.message || 'Lỗi không xác định');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra: ' + error.message);
            })
            .finally(() => {
                // Dù thành công hay thất bại cũng bật lại nút
                cancelButton.disabled = false;
                spinner.classList.add('hidden');
                cancelButton.classList.remove('opacity-75');
            });
    }
</script>
<script>
    // Biến toàn cục
    let currentRating = 0;
    let isLoading = false;

    // Khởi tạo sao đánh giá
    function initStarRating() {
        const container = document.getElementById('starRating');
        container.innerHTML = '';

        for (let i = 1; i <= 5; i++) {
            const star = document.createElement('button');
            star.type = 'button';
            star.className = 'text-4xl focus:outline-none transition-transform transform hover:scale-110 text-gray-300';
            star.innerHTML = '★';
            star.dataset.value = i;

            star.addEventListener('click', function() {
                currentRating = parseInt(this.dataset.value);
                updateStarRating();
            });

            container.appendChild(star);
        }
    }

    // Cập nhật hiển thị sao
    function updateStarRating() {
        const stars = document.querySelectorAll('#starRating button');
        stars.forEach(star => {
            const value = parseInt(star.dataset.value);
            star.className = `text-4xl focus:outline-none transition-transform transform hover:scale-110 ${
                value <= currentRating ? 'text-yellow-400' : 'text-gray-300'
            }`;
        });

        document.getElementById('ratingText').textContent = currentRating === 0 ? '' : `${currentRating} sao`;
    }

    // Mở modal
    function openRatingModal(bookingId, tourId, tourName) {
        currentRating = 0;
        isLoading = false;

        document.getElementById('ratingBookingId').value = bookingId;
        document.getElementById('ratingTourId').value = tourId;
        document.getElementById('tourNameDisplay').textContent = tourName;
        document.getElementById('comment').value = '';

        document.getElementById('ratingModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        updateStarRating();
    }

    // Đóng modal
    function closeRatingModal() {
        document.getElementById('ratingModal').classList.add('hidden');
        document.body.style.overflow = '';
    }

    // Gửi đánh giá
    async function submitRating() {
        if (currentRating === 0) {
            alert('Vui lòng chọn điểm đánh giá');
            return;
        }

        const btn = document.getElementById('submitRatingBtn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang gửi...';
        btn.disabled = true;

        console.log(JSON.stringify({
            booking_id: document.getElementById('ratingBookingId').value,
            tour_id: document.getElementById('ratingTourId').value,
            user_id: document.getElementById('ratingUserId').value,
            rating: currentRating,
            comment: document.getElementById('comment').value
        }));

        try {
            const response = await fetch('/Client/Rate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    booking_id: document.getElementById('ratingBookingId').value,
                    tour_id: document.getElementById('ratingTourId').value,
                    user_id: document.getElementById('ratingUserId').value,
                    rating: currentRating,
                    comment: document.getElementById('comment').value
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'Lỗi khi gửi đánh giá');
            }

            if (data.success) {
                alert('Cảm ơn bạn đã đánh giá!');
                closeRatingModal();
                window.location.reload();
            } else {
                throw new Error(data.message || 'Lỗi khi gửi đánh giá');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        } finally {
            btn.innerHTML = 'Gửi đánh giá';
            btn.disabled = false;
        }
    }

    // Gắn sự kiện
    document.addEventListener('DOMContentLoaded', function() {
        initStarRating();

        // Nút đóng
        document.getElementById('closeRatingModal').addEventListener('click', closeRatingModal);

        // Nút gửi
        document.getElementById('submitRatingBtn').addEventListener('click', submitRating);

        // Tắt khi click bên ngoài
        document.getElementById('ratingModal').addEventListener('click', function(e) {
            if (e.target === this) closeRatingModal();
        });

        // Tắt bằng phím ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !document.getElementById('ratingModal').classList.contains('hidden')) {
                closeRatingModal();
            }
        });
    });

    // Xử lý nút Hoàn thành
    document.addEventListener('click', function(e) {
        if (e.target.closest('.complete-tour-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.complete-tour-btn');
            console.log(btn.dataset.tourId);
            console.log(btn.dataset.tourName);
            console.log(btn.dataset.bookingId);
            openRatingModal(
                btn.dataset.bookingId,
                btn.dataset.tourId,
                btn.dataset.tourName
            );
        }
    });
</script>
</body>
</html>